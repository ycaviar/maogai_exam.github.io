<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¤‡è€ƒç³»ç»Ÿ</title>
<style>
    /* === ç±³å’–è‰²ç³»é…è‰²å®šä¹‰ === */
    /* === å‡çº§ç‰ˆï¼šé†‡åšæ‹¿é“é…è‰² (Premium Latte) === */
    /* === 2025 æ–°é…è‰²ï¼šç‡•éº¦æ‹¿é“ (Oat Latte) === */
    :root {
        /* ğŸŸ¤ ä¸»æ–‡å­—è‰² - å’–å•¡æ£• */
        --dark: #5A4A42;
        
        /* ğŸŸ¢ å¼ºè°ƒè‰² - ç°ç»¿è‰² (ç”¨äºæŒ‰é’®ã€é‡ç‚¹æ–‡å­—) */
        --primary: #71816B;
        
        /* ğŸŸ« ä¸»èƒŒæ™¯è‰² - ç‡•éº¦ç±³å’– (å¤§é¢ç§¯èƒŒæ™¯) */
        --bg: #E8DFD8;
        
        /* â¬œ å¡ç‰‡èƒŒæ™¯ - å¥¶æ²¹ç™½ (é«˜äº®åŒº) */
        --card-bg: #FEFCF9;
        
        /* âœ¨ è£…é¥°è‰² - æµ…é‡‘è‰² (è¾¹æ¡†ã€åˆ†å‰²çº¿) */
        --border-color: #B89B75;
        
        /* è¾…åŠ©è‰²ï¼šæµ…å’– (ç”¨äºé€‰ä¸­æ€ï¼ŒåŸºäºæµ…é‡‘è‰²è°ƒæ·¡) */
        --light-coffee: #F0EBE5; 

        /* çŠ¶æ€è‰² (ä¿æŒåŸæœ‰çš„è«å…°è¿ªè‰²ç³»ï¼Œæˆ–å¾®è°ƒ) */
        --success: #71816B;       /* æˆåŠŸä¹Ÿç”¨ç°ç»¿è‰²ï¼Œä¿æŒç»Ÿä¸€ */
        --error: #c05c48;         /* è±†æ²™çº¢ */
        --warning: #e09f3e;       /* å§œé»„ */
        
        /* é˜´å½±ï¼šä½¿ç”¨å’–å•¡è‰²è°ƒçš„æŠ•å½±ï¼Œæ›´èåˆ */
        --shadow-soft: 0 8px 20px rgba(90, 74, 66, 0.06);
        --shadow-hover: 0 12px 28px rgba(90, 74, 66, 0.12);

        /* è€ƒè¯•æ¨¡å¼è‰² */
        --exam-selected: #6b8eae; 
        --exam-selected-bg: #f0f6fa;
    }

    * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        
        /* === æ ¸å¿ƒä¿®å¤ï¼šæ‰¾å›å±…ä¸­å¸ƒå±€ === */
        display: flex;
        flex-direction: column;
        align-items: center; /* è¿™ä¸€è¡Œè®©å®¹å™¨æ°´å¹³å±…ä¸­ */
        min-height: 100vh;
        margin: 0;
        padding: 15px;
        
        /* === æ–°é…è‰²åº”ç”¨ === */
        background-color: var(--bg);
        color: var(--dark);
    }
    
    .app-subtitle {
        text-align: center !important; 
        width: 100% !important;
        
        /* ä¿®æ”¹é¢œè‰²ï¼šç™½è‰²åŠé€æ˜ -> æµ…å’–ç°è‰² */
        color: #8b653d;
        
        font-size: 13px;
        margin: 0;
    }

    .container {
        background: var(--card-bg);
        width: 100%;
        max-width: 800px;
        border-radius: 16px;
        box-shadow: 0 8px 30px rgba(74, 59, 50, 0.08);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        height: 85vh;
        min-height: 600px;
        position: relative;
    }

    @media (max-width: 600px) {
        body {
            padding: 0;
            background: var(--card-bg);
        }

        .container {
            width: 100%;
            height: 100vh;
            border-radius: 0;
            box-shadow: none;
            max-width: 100%;
        }
    }

    .view-section {
        display: none;
        flex: 1;
        flex-direction: column;
        height: 100%;
    }

    .view-section.active {
        display: flex;
    }

    /* === é¦–é¡µï¼šç°ä»£ä»ªè¡¨ç›˜é£æ ¼ === */
    .start-screen { 
        padding: 0; 
        display: flex; 
        flex-direction: column; 
        height: 100%; 
        overflow-y: auto; 
        
        /* ä¿®æ”¹èƒŒæ™¯ï¼šæ”¹ä¸ºå’–å•¡è‰²æ¸å˜ */
        background: transparent !important;
        
        /* æ–°å¢ï¼šåº•éƒ¨åœ†è§’ (é˜²æ­¢æ·±è‰²æº¢å‡ºåˆ°åœ†è§’å®¹å™¨å¤–) */
        border-radius: 0;
    }
    
    /* 1. é¡¶éƒ¨ Hero åŒºåŸŸ */
    .home-header {
        /* ä¿®æ”¹èƒŒæ™¯ï¼šæ”¹ä¸ºç±³è‰² (var(--bg)) */
        background: var(--bg);
        
        /* ä¿®æ”¹é˜´å½±ï¼šå˜æ·¡ä¸€ç‚¹ï¼Œé€‚åº”æµ…è‰²èƒŒæ™¯ */
        box-shadow: 0 10px 20px rgba(0,0,0,0.03);
        border-bottom: 1px solid rgba(184, 155, 117, 0.2);
        
        /* ä¿®æ”¹åœ†è§’å’Œè¾¹è· (ä¿æŒä¸å˜) */
        border-radius: 0 0 30px 30px;
        padding: 40px 25px 60px;
        margin-bottom: -30px;
        
        /* ä¿®æ”¹æ–‡å­—é¢œè‰²ï¼šæ”¹ä¸ºæ·±è‰² */
        color: var(--dark);
        
        flex-shrink: 0;
        
        /* å¸ƒå±€å±æ€§ (ä¿æŒä¸å˜) */
        display: flex !important;
        flex-direction: column !important;
        align-items: center !important;
        justify-content: center !important;
        text-align: center !important;
    }
    .user-greeting {
        display: flex !important;
        justify-content: center !important;
        align-items: center !important;
        width: 100% !important;
        text-align: center !important;
        
        font-size: 24px; 
        font-weight: 800; 
        margin-bottom: 8px; 
        

        color: var(--dark); 
    }
    .app-subtitle { opacity: 0.9; font-size: 13px; margin: 0; color: rgba(255,255,255,0.9); text-align: left; }

    /* 2. ä¸»åŠŸèƒ½å¡ç‰‡åŒº */
    .menu-section { padding: 0 20px; margin-bottom: 25px; flex-shrink: 0; }
    .menu-grid { 
        display: grid; grid-template-columns: 1fr; gap: 15px; 
        width: 100%; max-width: 100%; margin: 0 auto; 
    }
    @media (hover: hover) {
        .menu-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-hover);
            border-color: var(--primary);
        }
    }

    .menu-card {
        /* æ ¸å¿ƒå¸ƒå±€ä¿®å¤ */
        display: flex;           /* è®©å›¾æ ‡å’Œæ–‡å­—æ¨ªå‘æ’åˆ— */
        align-items: center;     /* å‚ç›´æ–¹å‘å±…ä¸­å¯¹é½ */
        padding: 20px;           /* å¢åŠ å†…éƒ¨ç•™ç™½ï¼Œä¸å†è´´è¾¹ */
        gap: 15px;               /* å›¾æ ‡å’Œæ–‡å­—ä¹‹é—´çš„é—´è· */
        
        /* ä¿æŒåŸæœ‰çš„é«˜çº§è´¨æ„Ÿ */
        border: 1px solid rgba(255,255,255,0.8);
        box-shadow: var(--shadow-soft);
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        transform: translateY(0);
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        cursor: pointer;         /* é¼ æ ‡æ”¾ä¸Šå»å˜å°æ‰‹ */
    }
    .menu-card:active {
        transform: scale(0.98);
        background: #fff;
    }
    
    .menu-icon-box {
        width: 54px;            /* å›ºå®šå®½åº¦ */
        height: 54px;           /* å›ºå®šé«˜åº¦ */
        display: flex;          /* å¯ç”¨ Flex */
        align-items: center;    /* å‚ç›´å±…ä¸­ */
        justify-content: center;/* æ°´å¹³å±…ä¸­ */
        flex-shrink: 0;         /* é˜²æ­¢å›¾æ ‡è¢«æŒ¤æ‰ */
        
        /* é¢œè‰²æ ·å¼ */
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        color: var(--primary);
        
        border-radius: 18px;    /* æ–¹åœ†å½¢ */
        font-size: 26px;        /* å›¾æ ‡å¤§å° */
    }
    .menu-text { 
        display: flex; 
        flex-direction: column; 
        flex: 1;                /* å æ»¡å‰©ä½™ç©ºé—´ */
        justify-content: center;/* æ–‡å­—å—è‡ªèº«å‚ç›´å±…ä¸­ */
    }
    .menu-title { 
        font-size: 17px; 
        font-weight: bold; 
        color: var(--dark); 
        margin-bottom: 4px; 
        line-height: 1.2;
    }
    .menu-desc { 
        font-size: 13px; 
        color: #9d8b80; 
    }
    
    .card-mistake .menu-icon-box { background: #fdf2f2; }
    .card-mistake .menu-title { color: var(--error); }
    .card-mistake .menu-icon-box { color: var(--error); }

    /* 3. å·¥å…·æ åŒºåŸŸ */
    .tools-section { padding: 0 20px 30px; }
    .section-label { 
        font-size: 13px; 
        font-weight: bold; 
        
        /* ä¿®æ”¹é¢œè‰²ï¼šæ·±ç° -> ç™½è‰²åŠé€æ˜ */
        color: var(--border-color); 
        
        margin-bottom: 12px; 
        padding-left: 5px; 
    }
    
    .tools-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .tool-btn {
        background: #fcfaf8; border: 1px solid var(--border-color);
        padding: 12px; border-radius: 10px;
        font-size: 13px; color: #6d5d53; font-weight: 600;
        display: flex; align-items: center; justify-content: center; gap: 8px;
        cursor: pointer; transition: 0.2s;
    }
    .tool-btn:active { background: var(--light-coffee); border-color: #d7ccc8; }
    .tool-btn i { font-style: normal; font-size: 16px; }
    .tool-lock { color: var(--error); background: #fffbfb; border-color: #f2e6e6; }

    /* === é¡¶éƒ¨æ  === */
    .select-header,
    .quiz-header {
        padding: 15px 20px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: #fff;
        flex-shrink: 0;
        height: 60px;
    }

    .back-icon {
        cursor: pointer;
        font-size: 22px;
        padding: 5px 10px 5px 0;
        color: #6d5d53;
        font-weight: bold;
    }

    .header-title {
        font-size: 18px;
        font-weight: bold;
        color: var(--dark);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        margin-left: 5px;
    }

    .exit-btn {
        font-size: 14px;
        color: var(--error);
        cursor: pointer;
        border: 1px solid var(--error);
        padding: 6px 12px;
        border-radius: 20px;
        background: white;
        margin-left: 10px;
    }

    /* === è®¡æ—¶å™¨æ ·å¼ === */
    .timer-badge {
        font-family: monospace;
        font-size: 16px;
        font-weight: bold;
        color: var(--dark);
        background: var(--light-coffee);
        padding: 4px 10px;
        border-radius: 6px;
        margin: 0 10px;
        flex-shrink: 0;
    }
    
    /* å€’è®¡æ—¶å³å°†ç»“æŸæ—¶çš„æ ·å¼ */
    .timer-badge.urgent {
        color: #fff;
        background: var(--error);
        animation: pulse 1s infinite;
    }

    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.8; }
        100% { opacity: 1; }
    }

    .score-board {
        font-size: 14px;
        font-weight: bold;
        color: var(--primary);
        background: var(--light-coffee);
        padding: 6px 15px;
        border-radius: 20px;
    }

    /* === åˆ—è¡¨ === */
    .set-list {
        padding: 20px;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 15px;
        overflow-y: auto;
        background: var(--bg);
    }

    @media (max-width: 600px) {
        .set-list {
            grid-template-columns: 1fr 1fr;
        }
    }

    .set-card {
        background: white;
        border: 1px solid var(--border-color);
        padding: 20px;
        border-radius: 12px;
        cursor: pointer;
        position: relative;
        transition: 0.2s;
        box-shadow: 0 2px 8px rgba(74, 59, 50, 0.03);
    }

    .set-card:active {
        border-color: var(--primary);
        background: var(--light-coffee);
    }

    .set-num {
        font-size: 18px;
        font-weight: bold;
        color: var(--dark);
        margin-bottom: 5px;
    }

    .set-info {
        font-size: 13px;
        color: #9d8b80;
    }

    /* === ç­”é¢˜åŒº === */
    .quiz-area {
        padding: 20px;
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        background: #fff;
    }

    .progress-bar {
        height: 6px;
        background: #eee;
        border-radius: 3px;
        margin-bottom: 20px;
        overflow: hidden;
        flex-shrink: 0;
    }

    .progress-fill {
        height: 100%;
        background: var(--primary);
        width: 0%;
        transition: width 0.3s;
    }

    .question-meta {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
        justify-content: space-between;
        font-size: 14px;
        color: #8d7b72;
    }

    .meta-left {
        display: flex;
        align-items: center;
    }

    .point-tag {
        font-size: 12px;
        color: #999;
        margin-left: 8px;
    }

    .source-tag {
        font-size: 12px;
        background: #f5f5f5;
        padding: 2px 6px;
        border-radius: 4px;
        color: #888;
        margin-left: 8px;
    }

    .badge {
        padding: 4px 8px;
        border-radius: 6px;
        color: white;
        font-size: 12px;
        font-weight: bold;
        margin-right: 8px;
        display: inline-block;
    }
    
    .badge-judge { background: #9d8189; }
    .badge-single { background: var(--primary); }
    .badge-multi { background: #7a9e9f; }

    .question-text {
        font-size: 18px;
        color: var(--dark);
        line-height: 1.7;
        margin-bottom: 25px;
        font-weight: 600;
    }

    .options-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding-bottom: 20px;
    }

    .option-item {
        border: 1px solid var(--border-color);
        box-shadow: 0 2px 8px rgba(0,0,0,0.02);
        
        /* æ–°å¢/ä¿®æ”¹ä»¥ä¸‹å±æ€§ï¼š */
        display: flex;          /* å¯ç”¨ Flex å¸ƒå±€ */
        align-items: center;    /* å…³é”®ï¼šè®©æ–‡å­—å‚ç›´å±…ä¸­ */
        padding: 12px 15px;     /* å¢åŠ å†…è¾¹è·ï¼Œè®©æŒ‰é’®æ›´å¤§æ°” */
        border-radius: 8px;     /* åœ†è§’ */
        background-color: #fff; /* ç¡®ä¿èƒŒæ™¯æ˜¯ç™½è‰² */
        cursor: pointer;        /* é¼ æ ‡æ‚¬åœå˜æ‰‹å‹ */
        transition: all 0.2s;   /* æ·»åŠ ç‚¹å‡»åŠ¨æ•ˆ */
        min-height: 50px;       /* ä¿è¯æœ€å°é«˜åº¦ï¼Œé˜²æ­¢æ–‡å­—å¤ªå°‘æ—¶æŒ‰é’®å¤ªæ‰ */
    }

    .option-item:active {
        background-color: #fafafa;
        border-color: #e0e0e0;
        transform: scale(0.99); /* ç‚¹å‡»æ—¶çš„å¾®ç¼©æ•ˆæœ */
    }

    /* === ç»ƒä¹ æ¨¡å¼æ ·å¼ === */
    .option-item.selected {
        border-color: var(--primary);
        background-color: var(--light-coffee);
        color: var(--primary);
        font-weight: 500;
    }
    .option-item.correct {
        border-color: var(--success);
        background-color: #f1f8e9;
        color: #33691e;
    }
    .option-item.wrong {
        border-color: var(--error);
        background-color: #fdf2f2;
        color: #8c2f2f;
    }

    .option-item .opt-tag {
        font-weight: bold;
        width: 32px;            /* å›ºå®šå®½åº¦ï¼Œç¡®ä¿æ‰€æœ‰é€‰é¡¹æ–‡å­—å¯¹é½ */
        color: #a18e84;
        flex-shrink: 0;         /* é˜²æ­¢æ ‡ç­¾è¢«æŒ¤å‹ */
        text-align: center;     /* æ ‡ç­¾æ–‡å­—æ°´å¹³å±…ä¸­ */
        margin-right: 10px;     /* æ ‡ç­¾å’Œç­”æ¡ˆä¹‹é—´çš„è·ç¦» */
        
        /* ç§»é™¤åŸæœ¬å¯èƒ½å­˜åœ¨çš„ margin-topï¼Œç”± Flex è‡ªåŠ¨æ§åˆ¶å±…ä¸­ */
        margin-top: 0; 
    }
    
    .option-item.selected .opt-tag { color: var(--primary); }
    .option-item.correct .opt-tag { color: var(--success); }
    .option-item.wrong .opt-tag { color: var(--error); }

    /* === è€ƒè¯•æ¨¡å¼é€‰ä¸­æ€ (è“è‰²) === */
    .mode-exam .option-item.selected { 
        border-color: var(--exam-selected); 
        background: var(--exam-selected-bg); 
        color: var(--exam-selected); 
        font-weight: 500;
    }
    .mode-exam .option-item.selected .opt-tag { color: var(--exam-selected); }


    /* === åº•éƒ¨æ§åˆ¶ === */
    .quiz-footer {
        padding: 15px 20px;
        border-top: 1px solid var(--border-color);
        background: #fff;
        flex-shrink: 0;
        z-index: 10;
    }

    .feedback {
        font-weight: bold;
        font-size: 16px;
        height: 24px;
        margin-bottom: 15px;
        text-align: center;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 15px;
    }

    @media (max-width: 600px) {
        .controls {
            flex-direction: column-reverse;
        }

        .nav-btns {
            width: 100%;
        }

        .jump-box {
            width: 100%;
            justify-content: center;
            border-top: 1px solid #f5f5f5;
            padding-top: 10px;
        }
    }

    .nav-btns {
        display: flex;
        gap: 10px;
        flex: 1;
    }

    .btn {
        padding: 12px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 15px;
        font-weight: 600;
        transition: 0.2s;
        flex: 1;
        text-align: center;
    }

    .btn-primary:active {
        box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
    }
    .btn-primary {
        background: var(--primary) !important;
        border: 1px solid transparent;
        box-shadow: 0 4px 12px rgba(113, 129, 107, 0.3);
    }
    .btn-outline { background: #f8f9fa; border: 1px solid #ddd; color: #555; }
    .btn-kill { background: var(--error); color: white; display: none; }

    .jump-box { display: flex; align-items: center; gap: 8px; }
    .jump-input { width: 60px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; text-align: center; font-size: 14px; -webkit-appearance: none; color: var(--dark); }
    .jump-btn { padding: 8px 12px; background: #eee; border: none; border-radius: 6px; color: #555; font-size: 13px; }

    /* === å¼¹çª— === */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(44, 34, 30, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        backdrop-filter: blur(2px);
    }

    .modal-content {
        background: white;
        width: 600px;
        max-width: 90%;
        max-height: 85vh;
        border-radius: 16px;
        padding: 20px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(74, 59, 50, 0.2);
        color: var(--dark);
    }

    .modal-header {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
        color: var(--primary);
    }

    /* å¯¼å…¥ç•Œé¢ */
    .import-layout {
        display: flex;
        flex: 1;
        gap: 15px;
        overflow: hidden;
        min-height: 200px;
        flex-direction: column;
    }

    @media (min-width: 600px) { .import-layout { flex-direction: row; } }

    .import-inputs,
    .import-preview {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 10px;
        overflow: hidden;
    }

    .import-preview {
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 10px;
        background: #faf9f6;
        max-height: 200px;
        overflow-y: auto;
    }

    .input-group textarea {
        flex: 1;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 8px;
        font-family: monospace;
        resize: none;
        font-size: 13px;
        height: 100px;
        background: #fff;
    }
    
    .input-group label { font-size: 12px; font-weight: bold; color: #888; }

    /* éšæœºé…ç½® */
    .config-section { margin-bottom: 15px; flex-shrink: 0; }
    .set-checkbox-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 8px;
        max-height: 120px;
        overflow-y: auto;
        border: 1px solid var(--border-color);
        padding: 10px;
        background: #faf9f6;
        border-radius: 8px;
    }
    @media (min-width: 500px) { .set-checkbox-grid { grid-template-columns: 1fr 1fr; } }
    
    .score-config-grid { display: grid; grid-template-columns: 1fr; gap: 10px; margin-bottom: 10px; }
    .score-config-item {
        background: #f8f7f4;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .score-input-group { display: flex; align-items: center; gap: 5px; font-size: 12px; }
    .config-input { width: 50px; padding: 6px; border: 1px solid #ccc; border-radius: 4px; text-align: center; }

    /* æˆç»©å• */
    .result-card { text-align: center; padding: 10px; }
    .final-score {
        font-size: 56px;
        font-weight: 800;
        color: var(--primary);
        margin: 10px 0;
    }
    .score-detail {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-bottom: 20px;
        font-size: 14px;
    }
    .preview-item {
        padding: 8px 0;
        border-bottom: 1px dashed #eee;
        display: flex;
        justify-content: space-between;
        gap: 10px;
        font-size: 12px;
    }
    .preview-ans { color: var(--success); font-weight: bold; }

    /* === ç™»å½•é”å±æ ·å¼ === */
    .login-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #4a3b32;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }
    .login-card {
        background: white;
        padding: 30px;
        border-radius: 16px;
        width: 300px;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
    }
    .login-title { font-size: 20px; font-weight: bold; margin-bottom: 20px; color: var(--dark); }
    .login-input {
        width: 100%;
        padding: 12px;
        border: 2px solid #eee;
        border-radius: 8px;
        margin-bottom: 15px;
        font-size: 16px;
        text-align: center;
        outline: none;
        transition: 0.3s;
        color: var(--dark);
    }
    .login-input:focus { border-color: var(--primary); }
    .login-btn {
        width: 100%;
        padding: 12px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
    }
    .login-error { color: var(--error); font-size: 14px; margin-top: 10px; min-height: 20px; }

    /* === é”™é¢˜åœºæ¬¡åˆ—è¡¨ === */
    .mistake-session-list { overflow-y: auto; padding: 5px; }
    .session-card {
        background: #fcfaf8; border: 1px solid var(--border-color);
        padding: 15px; border-radius: 10px; margin-bottom: 10px;
        cursor: pointer; display: flex; justify-content: space-between; align-items: center;
    }
    .session-card:active { background: var(--light-coffee); }
    .session-date { font-weight: bold; font-size: 14px; }
    .session-info { font-size: 12px; color: #888; margin-top: 4px; }
    .session-count { font-weight: bold; color: var(--error); background: #fff5f5; padding: 4px 8px; border-radius: 12px; font-size: 12px; }

    /* === ç­”é¢˜å¡å¼¹çª—æ ·å¼ === */
    .card-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(45px, 1fr));
        gap: 12px;
        padding: 10px;
        max-height: 60vh;
        overflow-y: auto;
    }

    .card-item {
        width: 45px;
        height: 45px;
        border-radius: 50%; /* åœ†å½¢ */
        background: #f8f9fa;
        border: 1px solid #ddd;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: bold;
        color: #666;
        cursor: pointer;
        transition: 0.2s;
    }

    /* å½“å‰æ‰€åœ¨é¢˜ */
    .card-item.current {
        border-color: var(--primary);
        color: var(--primary);
        box-shadow: 0 0 0 2px var(--light-coffee);
    }

    /* å·²ä½œç­” */
    .card-item.done {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }
    
    /* è€ƒè¯•æ¨¡å¼ä¸‹çš„å·²ä½œç­” (è“è‰²ç³») */
    .mode-exam .card-item.done {
        background: #4a90e2;
        border-color: #4a90e2;
    }

    /* æ ‡è®°/æ­£ç¡®/é”™è¯¯ (é¢„ç•™æ‰©å±•ï¼Œç›®å‰åªåšå·²ç­”) */




    /* === ç­”é¢˜å¡ï¼šéæ¨¡æ€æ‚¬æµ®ä¾§è¾¹æ  === */
    #card-modal {
        /* å…³é”® 1ï¼šè®©å¤–å±‚é®ç½©â€œéšèº«â€ä¸”â€œä¸æŒ¡é¼ æ ‡â€ */
        background: transparent !important; /* å®Œå…¨é€æ˜ */
        backdrop-filter: none !important;   /* å»é™¤æ¨¡ç³Š */
        pointer-events: none;               /* è®©ç‚¹å‡»ç©¿é€ï¼Œç›´è¾¾åº•ä¸‹çš„é¢˜ç›® */
        
        /* å¸ƒå±€è°ƒæ•´ */
        justify-content: flex-end; /* é å³æ˜¾ç¤º */
        align-items: stretch;
    }

    #card-modal .modal-content {
        /* å…³é”® 2ï¼šè®©ä¾§è¾¹æ æœ¬ä½“â€œæ¢å¤â€ç‚¹å‡» */
        pointer-events: auto; 
        
        /* æ ·å¼ç¾åŒ– */
        width: 240px;            /* ç¨å¾®çª„ä¸€ç‚¹ï¼Œç•™å‡ºæ›´å¤šç©ºé—´ç»™é¢˜ç›® */
        margin: 0;               /* å»é™¤é»˜è®¤è¾¹è· */
        height: 100%;            /* å æ»¡é«˜åº¦ */
        max-height: 100%;
        border-radius: 20px 0 0 20px; /* å·¦ä¾§åœ†è§’ */
        box-shadow: -5px 0 20px rgba(0, 0, 0, 0.1); /* æ·»åŠ é˜´å½±ï¼ŒåŒºåˆ†å±‚çº§ */
        background: rgba(255, 255, 255, 0.95); /* å¾®å¾®åŠé€æ˜çš„ç™½è‰²èƒŒæ™¯ */
        border-left: 1px solid var(--border-color);
        
        /* åŠ¨ç”» */
        animation: slideInRight 0.3s ease-out;
    }

    @keyframes slideInRight {
        from { transform: translateX(100%); }
        to { transform: translateX(0); }
    }
    
    /* è°ƒæ•´ç½‘æ ¼é—´è·ï¼Œä½¿å…¶åœ¨çª„ä¾§è¾¹æ é‡Œæ›´å¥½çœ‹ */
    .card-grid {
        padding: 15px 10px;
        grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); /* ç¨å¾®è°ƒå°æ ¼å­çš„æœ€å°å®½åº¦ */
        gap: 8px;
    }
    .card-item {
        width: 40px; height: 40px; font-size: 13px; /* ç¨å¾®è°ƒå°åœ†åœˆ */
    }

    /* === å­˜æ¡£ç®¡ç†é¡µé¢æ ·å¼ === */
    .archive-card {
        background: white;
        border: 1px solid var(--border-color);
        padding: 15px 20px;
        border-radius: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        transition: 0.2s;
        box-shadow: 0 2px 5px rgba(0,0,0,0.02);
    }
    .archive-info {
        display: flex;
        flex-direction: column;
        cursor: pointer; /* ç‚¹å‡»åå­—ä¹Ÿèƒ½åˆ‡æ¢ */
        flex: 1;
    }
    .archive-name {
        font-size: 16px;
        font-weight: bold;
        color: var(--dark);
        display: flex;
        align-items: center;
    }
    .tag-current {
        background: var(--primary);
        color: white;
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 4px;
        margin-left: 8px;
        font-weight: normal;
    }
    .archive-detail {
        font-size: 12px;
        color: #999;
        margin-top: 4px;
    }
    .archive-actions {
        display: flex;
        gap: 10px;
    }
    .btn-icon {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        border: 1px solid #eee;
        background: #fcfaf8;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 16px;
        color: #666;
    }
    .btn-icon:active { background: #eee; }
    .btn-delete { color: var(--error); border-color: #ffeaea; background: #fff5f5; }

    /* === æ–°å¢ AI åŠ©æ‰‹æ ·å¼ === */
    .ai-content-area {
        flex: 1;
        overflow-y: auto;
        line-height: 1.6;
        font-size: 15px;
        color: #4a3b32;
        white-space: pre-wrap; /* ä¿ç•™æ¢è¡Œ */
        padding: 15px;
        background: #faf9f6;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        margin-bottom: 10px;
        font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    }
    
    /* æ¨¡æ‹Ÿ Markdown çš„ä¸€äº›ç®€å•é«˜äº® */
    .ai-content-area strong, .ai-content-area b {
        color: #8b653d;
        background: rgba(184, 155, 117, 0.15);
        padding: 0 4px;
        border-radius: 4px;
        font-weight: bold;
    }

    /* æ‰“å­—æœºå…‰æ ‡åŠ¨ç”» */
    .cursor-blink {
        display: inline-block;
        width: 2px;
        height: 15px;
        background-color: var(--primary);
        animation: blink 1s infinite;
        vertical-align: middle;
        margin-left: 2px;
    }
    @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0; } 100% { opacity: 1; } }



    @keyframes slideDown {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
    }


    @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
    }
</style>
</head>
<body>

    <div id="login-modal" class="login-overlay">
        <div class="login-card">
            <div class="login-title">åˆ·é¢˜ç³»ç»Ÿç™»å½•</div>
            <input type="text" id="login-user" class="login-input" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" autocomplete="off">
            <input type="password" id="login-pwd" class="login-input" placeholder="è¯·è¾“å…¥å¯†ç " onkeyup="if(event.key==='Enter') doLogin()">
            <button class="login-btn" onclick="doLogin()">è¿›å…¥ç³»ç»Ÿ</button>
            <div id="login-msg" class="login-error"></div>
        </div>
    </div>

    <div class="container">

        <div id="view-home" class="view-section active">
            <div class="start-screen">
                <div class="home-header">
                    <div class="user-greeting">
                        Hi, <span id="home-username">è€ƒç”Ÿ</span> ğŸ‘‹
                        <button style="font-size:12px; background:rgba(255,255,255,0.2); border:1px solid rgba(255,255,255,0.4); color:white; border-radius:10px; padding:2px 8px; margin-left:8px; cursor:pointer;" onclick="openArchiveManager()">
                            ğŸ” ç®¡ç†å­˜æ¡£
                        </button>
                    </div>
                    <div class="app-subtitle">ä¿æŒä¸“æ³¨ï¼Œä»Šå¤©ä¹Ÿè¦åŠ æ²¹ï¼</div>
                </div>
                
                <div class="menu-section">
                    <div class="menu-grid">
                        <div class="menu-card" onclick="goToSetSelection()">
                            <div class="menu-icon-box">ğŸ“š</div>
                            <div class="menu-text">
                                <div class="menu-title">æŒ‰å¥—åˆ·é¢˜</div>
                                <div class="menu-desc">é¡ºåºç»ƒä¹  Â· åŸºç¡€å·©å›º</div>
                            </div>
                        </div>
                        <div class="menu-card" onclick="openRandomConfig()">
                            <div class="menu-icon-box">ğŸ†</div>
                            <div class="menu-text">
                                <div class="menu-title">æ¨¡æ‹Ÿè€ƒè¯•</div>
                                <div class="menu-desc">éšæœºç»„å· Â· è‡ªåŠ¨æ‰“åˆ†</div>
                            </div>
                        </div>
                        <div class="menu-card card-mistake" onclick="openMistakeSelector()">
                            <div class="menu-icon-box">ğŸ–ï¸</div>
                            <div class="menu-text">
                                <div class="menu-title">é”™é¢˜æ”»åš</div>
                                <div class="menu-desc" id="mistake-count-label">0 é¢˜å¾…å¤ä¹ </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tools-section">
                    <div class="section-label">æ•°æ®ç®¡ç† & ç³»ç»Ÿ</div>
                    
                    <div class="tools-grid">

                        <div class="tool-btn" id="btn-shuffle-opt" onclick="toggleOptionShuffle()">
                            <i id="icon-shuffle">â¬œ</i> é€‰é¡¹ä¹±åº: å…³
                        </div>
                        <div class="tool-btn" onclick="openImportModal()">
                            <i>ğŸ“¥</i> å½•å…¥é¢˜åº“
                        </div>
                        <div class="tool-btn" onclick="exportToFile()">
                            <i>ğŸ’¾</i> å¤‡ä»½æ•°æ®
                        </div>
                        <div class="tool-btn" onclick="document.getElementById('file-input').click()">
                            <i>ğŸ“‚</i> æ¢å¤æ•°æ®
                            <input type="file" id="file-input" style="display:none" accept=".json" onchange="importFromFile(this)">
                        </div>
                        <div class="tool-btn tool-lock" onclick="doLogout()">
                            <i>ğŸ”’</i> é”å®šç¦»å¼€
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-select" class="view-section">
            <div class="select-header">
                <div class="back-icon" onclick="goHome()">â¬…ï¸</div>
                <div class="header-title">é€‰æ‹©ç»ƒä¹ å¥—é¢˜</div>
                <div style="width:24px;"></div>
            </div>
            <div class="set-list" id="set-list-container"></div>
        </div>


        <div id="view-archive" class="view-section">
            <div class="select-header">
                <div class="back-icon" onclick="goHome()">â¬…ï¸</div>
                <div class="header-title">å­˜æ¡£ç®¡ç†</div>
                <div style="width:24px;"></div>
            </div>
            <div style="padding: 20px; overflow-y: auto; flex: 1; background: var(--bg);">
                
                <div onclick="createNewArchive()" style="background: white; border: 2px dashed #ddd; border-radius: 12px; padding: 15px; text-align: center; color: var(--primary); font-weight: bold; cursor: pointer; margin-bottom: 20px;">
                    + æ–°å»ºå­˜æ¡£
                </div>

                <div id="archive-list-container"></div>
            </div>
        </div>


        <div id="view-quiz" class="view-section">
            <div class="quiz-header">
                <div style="display:flex; align-items:center; overflow:hidden; flex:1;">
                    <div class="back-icon" onclick="goHome()">â¬…ï¸</div>
                    <span id="quiz-mode-title" class="header-title">ç»ƒä¹ </span>
                </div>
                <div id="timer-display" class="timer-badge">00:00</div>
                <div style="display:flex; align-items:center; flex-shrink:0;">
                    <div id="live-score-board" class="score-board" style="display:none;">0</div>
                    <!-- ä¿®å¤ç‚¹ï¼šæ·»åŠ äº† ID btn-top-finish -->
                    <button class="exit-btn" id="btn-top-finish" onclick="finishExam()">äº¤å·</button>
                </div>
            </div>
            <div class="quiz-area">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div class="question-meta">
                    <div class="meta-left">
                        <span id="q-type" class="badge badge-single">å•é€‰</span>
                        <span id="q-point-tag" class="point-tag"></span>
                        <span id="q-source-tag" class="source-tag" style="display:none;"></span>
                    </div>
                    <span id="q-index" class="q-number">1/100</span>
                </div>
                <div id="q-text" class="question-text">åŠ è½½ä¸­...</div>
                <div id="q-options" class="options-list"></div>

                <div id="ai-inline-box" style="display:none; margin-top: 20px; padding-top: 20px; border-top: 2px dashed #eee; animation: slideDown 0.3s ease-out;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <span style="font-weight:bold; color:var(--primary); font-size:16px;">
                            ğŸ“ æ™ºèƒ½åŠ©æ•™è§£æ
                        </span>
                        <button onclick="closeAIInline()" style="font-size:13px; color:#999; background:none; border:none; cursor:pointer;">
                            æ”¶èµ· ğŸ”¼
                        </button>
                    </div>
                    
                    <div id="ai-content-area" class="ai-content-area" style="max-height:none; border:1px solid #e0d6ce; background:#fffcf9;"></div>
                    
                    <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:10px;">
                        <button class="btn btn-outline" style="font-size:12px; padding:6px 12px; height:auto;" onclick="openAIConfig()">
                            âš™ï¸ è®¾ç½®Key
                        </button>
                        <button class="btn btn-primary" style="font-size:12px; padding:6px 12px; height:auto;" onclick="requestAIExplanation()">
                            ğŸ”„ é‡æ–°ç”Ÿæˆ
                        </button>
                    </div>
                </div>
            </div>
            <div class="quiz-footer">
                <div id="feedback" class="feedback"></div>
                <div class="controls">
                    <div class="nav-btns">
                        <button id="btn-kill" class="btn btn-kill" onclick="killMistake()">ğŸ—‘ï¸ ç§»é™¤</button>
                        
                        <button class="btn btn-outline" style="border-color:#bcaaa4; color:#8d6e63; font-weight:bold;" onclick="askAI()">
                            âœ¨ AIè§£æ
                        </button>
                        <button class="btn btn-outline" onclick="nav(-1)">ä¸Šä¸€é¢˜</button>
                        <button id="btn-submit" class="btn btn-submit" onclick="submitAnswer()">æäº¤</button>
                        <button id="btn-next" class="btn btn-primary" onclick="nav(1)">ä¸‹ä¸€é¢˜</button>
                    </div>
                    
                    <div style="display: flex; align-items: center;">
                         <button class="btn btn-outline" style="padding:8px 15px; font-size:13px; white-space: nowrap;" onclick="openQuestionCard()">
                            ğŸ”¢ ç­”é¢˜å¡
                         </button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div id="import-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <span>é¢˜åº“ç®¡ç†</span>
                <button style="background:none; border:none; font-size:20px; color:#999;" onclick="closeImportModal()">Ã—</button>
            </div>
            <div style="background:#f8f9fa; padding:10px; border-radius:8px; margin-bottom:10px; display:flex; align-items:center; justify-content:space-between;">
                <div style="display:flex; align-items:center;">
                    <span style="font-size:14px; font-weight:bold;">ç¬¬</span>
                    <input type="number" id="import-set-num" value="1" min="1" style="margin:0 5px; width:50px; padding:5px; border:1px solid #ddd; border-radius:4px; text-align:center;" oninput="onSetNumChange()">
                    <span style="font-size:14px; font-weight:bold;">å¥—</span>
                </div>
                <button style="font-size:12px; color:red; border:1px solid red; background:none; padding:4px 8px; border-radius:4px;" onclick="deleteCurrentSet()">åˆ é™¤æ­¤å¥—</button>
            </div>
            <div class="import-layout">
                <div class="import-inputs">
                    <div class="input-group">
                        <label>é¢˜ç›®æ–‡æœ¬ (ç²˜è´´):</label>
                        <textarea id="raw-questions" placeholder="ä¾‹: 1. é¢˜ç›®... A. é€‰é¡¹..."></textarea>
                    </div>
                    <div class="input-group">
                        <label>ç­”æ¡ˆæ–‡æœ¬ (ç²˜è´´):</label>
                        <textarea id="raw-answers" placeholder="ä¾‹: 1~5: A B C..."></textarea>
                    </div>
                </div>
                <div class="import-preview">
                    <div style="font-size:12px; font-weight:bold; color:#555; margin-bottom:5px; border-bottom:1px solid #eee; padding-bottom:5px;">é¢„è§ˆ (<span id="preview-count">0</span>é¢˜)</div>
                    <div id="preview-list"></div>
                </div>
            </div>
            <div style="margin-top:15px;">
                <button class="btn btn-primary" style="width:100%" onclick="importData()">ä¿å­˜ / æ›´æ–°</button>
            </div>
        </div>
    </div>

    <div id="config-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <span>è€ƒè¯•è®¾ç½®</span>
                <button style="background:none; border:none; font-size:20px; color:#999;" onclick="closeRandomConfig()">Ã—</button>
            </div>
            <div class="config-section">
                <div style="font-size:14px; font-weight:bold; margin-bottom:8px;">é¢˜åº“æ¥æº</div>
                <div id="set-selection-area" class="set-checkbox-grid"></div>
                <div style="margin-top:5px; text-align:right;">
                    <a href="javascript:toggleAllSets(true)" style="font-size:12px;color:var(--primary);margin-right:10px;">å…¨é€‰</a>
                    <a href="javascript:toggleAllSets(false)" style="font-size:12px;color:#999;">æ¸…ç©º</a>
                </div>
            </div>
            <div class="config-section">
                <div style="font-size:14px; font-weight:bold; margin-bottom:8px;">é¢˜é‡ä¸åˆ†å€¼</div>
                <div class="score-config-grid">
                    <div class="score-config-item">
                        <span style="font-weight:bold; font-size:13px;">åˆ¤æ–­</span>
                        <div class="score-input-group"><input type="number" id="cfg-judge" class="config-input" value="20" oninput="updateTotal()">é¢˜</div>
                        <div class="score-input-group"><input type="number" id="pts-judge" class="config-input" value="1" oninput="updateTotal()">åˆ†</div>
                    </div>
                    <div class="score-config-item">
                        <span style="font-weight:bold; font-size:13px;">å•é€‰</span>
                        <div class="score-input-group"><input type="number" id="cfg-single" class="config-input" value="60" oninput="updateTotal()">é¢˜</div>
                        <div class="score-input-group"><input type="number" id="pts-single" class="config-input" value="1" oninput="updateTotal()">åˆ†</div>
                    </div>
                    <div class="score-config-item">
                        <span style="font-weight:bold; font-size:13px;">å¤šé€‰</span>
                        <div class="score-input-group"><input type="number" id="cfg-multi" class="config-input" value="20" oninput="updateTotal()">é¢˜</div>
                        <div class="score-input-group"><input type="number" id="pts-multi" class="config-input" value="1" oninput="updateTotal()">åˆ†</div>
                    </div>
                </div>
            </div>
            
            <div class="config-section">
                <div style="font-size:14px; font-weight:bold; margin-bottom:8px;">æ—¶é—´é™åˆ¶</div>
                <div class="score-config-item">
                    <span style="font-size:13px;">è€ƒè¯•æ—¶é•¿ (åˆ†é’Ÿ)</span>
                    <div class="score-input-group">
                        <input type="number" id="cfg-duration" class="config-input" value="90" placeholder="0ä¸é™">
                        <span>åˆ†</span>
                    </div>
                </div>
                <div style="font-size:12px; color:#999; margin-top:5px;">* è®¾ç½®ä¸º 0 æˆ–ç©ºåˆ™ä¸é™åˆ¶æ—¶é—´</div>
            </div>

            <div class="total-badge" style="text-align: center; margin: 10px 0;">
                æ€»åˆ†ï¼š<span id="cfg-total-score" style="color:var(--error); font-size:18px;">--</span> <span style="font-size:12px; color:#666;">(å…± <span id="cfg-total-count">--</span> é¢˜)</span>
            </div>
            <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="startRandomExam()">å¼€å§‹è€ƒè¯•</button>
        </div>
    </div>

    <div id="mistake-select-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <span>é”™é¢˜æ”»åš</span>
            <button style="background:none; border:none; font-size:24px; color:#999;" onclick="closeMistakeSelector()">Ã—</button>
        </div>
        <div style="margin-bottom:10px;">
            <button class="btn btn-primary" style="width:100%; margin-bottom:10px;" onclick="startAllMistakes()">å¤ä¹ æ‰€æœ‰é”™é¢˜ (å…± <span id="total-mistakes-num">0</span> é¢˜)</button>
            
            <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 15px; background: #faf9f6; padding: 8px; border-radius: 8px; border: 1px dashed var(--border-color);">
                <label style="cursor: pointer; display: flex; align-items: center; gap: 8px; user-select: none;">
                    <input type="checkbox" id="auto-remove-check" style="width: 18px; height: 18px; accent-color: var(--primary);" onchange="toggleAutoRemove(this)">
                    <span style="font-size: 14px; color: var(--dark); font-weight: bold;">ğŸ¯ ç­”å¯¹åè‡ªåŠ¨ç§»å‡ºè¯¥é¢˜</span>
                </label>
            </div>
            <div style="font-size:12px; color:#888; margin-bottom:5px;">æˆ–é€‰æ‹©å•æ¬¡è€ƒè¯•è®°å½•ï¼š</div>
        </div>
        <div id="mistake-session-list" class="mistake-session-list"></div>
    </div>
    </div>

    <div id="result-modal" class="modal-overlay">
        <div class="modal-content" style="width: 320px; height: auto; align-items: center;">
            <div class="modal-header" style="width:100%; justify-content:center;">è€ƒè¯•ç»“æŸ</div>
            <div class="result-card" style="width:100%">
                <div style="font-size:14px; color:#666;">æœ€ç»ˆå¾—åˆ†</div>
                <div class="final-score" id="res-score">0</div>
                <div class="score-detail">
                    <div>å¯¹:<span id="res-correct" style="color:var(--success);font-weight:bold;margin-left:4px;">0</span></div>
                    <div>é”™:<span id="res-wrong" style="color:var(--error);font-weight:bold;margin-left:4px;">0</span></div>
                    <div>ç©º:<span id="res-skipped" style="color:#999;font-weight:bold;margin-left:4px;">0</span></div>
                </div>
                <div style="font-size:13px; color:#888; margin-bottom:15px;" id="res-info"></div>
                <div style="font-size:13px; color:#888; margin-bottom:10px; background:#f9f9f9; padding:5px; border-radius:5px;">
                    è€—æ—¶: <span id="res-time-taken" style="font-weight:bold;color:var(--dark)">00:00</span>
                </div>

                <div style="font-size:12px; color:var(--error); margin-bottom:20px; display:none; background:#fff5f5; padding:8px; border-radius:6px;" id="res-mistake-hint"></div>
                <button class="btn btn-primary" style="width:100%" onclick="closeResultModal()">è¿”å›é¦–é¡µ</button>
            </div>
        </div>
    </div>

    <div id="card-modal" class="modal-overlay" onclick="if(event.target === this) closeQuestionCard()">
        <div class="modal-content">
            <div class="modal-header">
                <span>ç­”é¢˜å¡</span>
                <button style="background:none; border:none; font-size:24px; color:#999;" onclick="closeQuestionCard()">Ã—</button>
            </div>
            <div style="padding: 0 10px 10px;">
                <div style="font-size:12px; color:#888; margin-bottom:10px; display:flex; gap:15px;">
                    <span><span style="display:inline-block;width:10px;height:10px;border:1px solid #ddd;border-radius:50%;margin-right:4px;"></span>æœªåš</span>
                    <span><span style="display:inline-block;width:10px;height:10px;background:var(--primary);border-radius:50%;margin-right:4px;"></span>å·²åš</span>
                    <span><span style="display:inline-block;width:10px;height:10px;border:2px solid var(--primary);border-radius:50%;margin-right:4px;"></span>å½“å‰</span>
                </div>
            </div>
            <div id="question-card-grid" class="card-grid"></div>
        </div>
    </div>

    

    <div id="ai-config-modal" class="modal-overlay" style="z-index: 1100;">
        <div class="modal-content" style="max-width: 400px; height:auto;">
            <div class="modal-header">
                <span>âš™ï¸ AI é…ç½®</span>
                <button style="background:none; border:none; font-size:20px; color:#999;" onclick="document.getElementById('ai-config-modal').style.display='none'">Ã—</button>
            </div>
            <div style="font-size:13px; color:#666; margin-bottom:15px;">
                é…ç½® DeepSeek API Keyã€‚<br>
                <span style="color:var(--error); font-size:12px;">* å¯†é’¥ä»…ä¿å­˜åœ¨ä½ æœ¬åœ°æµè§ˆå™¨ä¸­ï¼Œä¸ä¼šä¸Šä¼ åˆ°ä»»ä½•æœåŠ¡å™¨ã€‚</span>
            </div>
            
            <div class="input-group" style="margin-bottom:10px;">
                <label>API Key (å¯†é’¥)</label>
                <input type="password" id="ai-api-key" class="login-input" style="text-align:left; font-size:14px;" placeholder="sk-xxxxxxxx">
            </div>

            <button class="btn btn-primary" style="width:100%" onclick="saveAIConfig()">ä¿å­˜é…ç½®</button>
        </div>
    </div>


<script>
    // === å…¨å±€æ•°æ®ç»“æ„å‡çº§ ===
    // globalData: å­˜å‚¨æ‰€æœ‰å­è´¦å·çš„æ€»ä»“åº“
    var globalData = {
        currentUser: "é»˜è®¤ç”¨æˆ·",
        users: {
            "é»˜è®¤ç”¨æˆ·": { mistakes: [], examHistory: [] }
        }
    };

    // database: è¿™æ˜¯ä¸€ä¸ªâ€œæŒ‡é’ˆâ€ï¼Œæ°¸è¿œæŒ‡å‘å½“å‰æ­£åœ¨ä½¿ç”¨çš„å­è´¦å·
    // è¿™æ ·ä¸‹é¢çš„åŸæœ‰ä»£ç ï¼ˆdatabase.mistakes...ï¼‰ç»Ÿç»Ÿä¸ç”¨æ”¹ï¼
    var database = globalData.users["é»˜è®¤ç”¨æˆ·"];
    
    var currentQuizList = []; 
    var currentIndex = 0; 
    var userAnswers = {}; 
    var submittedQuestions = {}; // æ–°å¢ï¼šä¸“é—¨è®°å½•å“ªäº›é¢˜å·²ç»â€œæäº¤â€äº†
    
    var mode = "practice"; // practice, exam, mistake
    var timerInterval = null; 
    var isAutoRemoveMistakes = false;
    var isOptionShuffle = false
    var secondsElapsed = 0; 
    var secondsRemaining = 0;

    // === æ¨¡æ‹Ÿ/æ¼”ç¤ºæ•°æ® (é˜²æ­¢æœ¬åœ°æ— æ•°æ®æ—¶æ˜¾ç¤ºç©ºç™½) ===
    var demoData = {
        "1": [
            {id:1, type:"å•é€‰é¢˜", text:"ä¸­å›½å…±äº§å…šæˆç«‹çš„æ—¶é—´æ˜¯ï¼Ÿ", options:["A. 1919å¹´", "B. 1921å¹´", "C. 1949å¹´", "D. 1978å¹´"], answer:"B", point:1},
            {id:2, type:"å•é€‰é¢˜", text:"ã€Šæœ¬è‰çº²ç›®ã€‹çš„ä½œè€…æ˜¯ï¼Ÿ", options:["A. åä½—", "B. ææ—¶ç", "C. æ‰é¹Š", "D. å¼ ä»²æ™¯"], answer:"B", point:1},
            {id:3, type:"åˆ¤æ–­é¢˜", text:"åœ°çƒå›´ç»•æœˆçƒè½¬ã€‚", options:["A. å¯¹", "B. é”™"], answer:"B", point:1},
            {id:4, type:"å¤šé€‰é¢˜", text:"ä»¥ä¸‹å±äºå››å¤§å‘æ˜çš„æ˜¯ï¼Ÿ", options:["A. é€ çº¸æœ¯", "B. æŒ‡å—é’ˆ", "C. ç«è¯", "D. ç®—ç›˜"], answer:"ABC", point:2},
            {id:5, type:"å•é€‰é¢˜", text:"1+1ç­‰äºå‡ ï¼Ÿ", options:["A. 1", "B. 2", "C. 3", "D. 4"], answer:"B", point:1}
        ]
    };

    // === åˆå§‹åŒ–ï¼šè¯»å–æ•°æ® & è‡ªåŠ¨å‡çº§ç»“æ„ ===
    window.onload = function() {
        var saved = localStorage.getItem('exam_db_v2');
        if (saved) { 
            try { 
                var parsed = JSON.parse(saved);
                
                // ã€å…³é”®é€»è¾‘ã€‘æ£€æµ‹æ˜¯å¦æ˜¯æ—§ç‰ˆæ•°æ®ï¼ˆæ²¡æœ‰ users å­—æ®µï¼‰
                if (!parsed.users) {
                    console.log("æ£€æµ‹åˆ°æ—§ç‰ˆæ•°æ®ï¼Œæ­£åœ¨è¿ç§»åˆ°é»˜è®¤å­è´¦å·...");
                    // æŠŠæ—§æ•°æ®å®Œæ•´å¡å…¥â€œé»˜è®¤ç”¨æˆ·â€
                    globalData.users["é»˜è®¤ç”¨æˆ·"] = parsed;
                    // è¡¥å…¨ç»“æ„
                    if (!globalData.users["é»˜è®¤ç”¨æˆ·"].mistakes) globalData.users["é»˜è®¤ç”¨æˆ·"].mistakes = [];
                    if (!globalData.users["é»˜è®¤ç”¨æˆ·"].examHistory) globalData.users["é»˜è®¤ç”¨æˆ·"].examHistory = [];
                    saveData(); // ç«‹å³ä¿å­˜æ–°ç»“æ„
                } else {
                    // å·²ç»æ˜¯æ–°ç‰ˆç»“æ„ï¼Œç›´æ¥è¯»å–
                    globalData = parsed;
                }
            } catch(e) { console.error("è¯»å–ç¼“å­˜å¤±è´¥", e); } 
        }

        // 1. è®¾ç½®æŒ‡é’ˆï¼šè®© database æŒ‡å‘å½“å‰ç”¨æˆ·
        // å¦‚æœå½“å‰è®°å½•çš„ç”¨æˆ·ä¸å­˜åœ¨ï¼ˆæ¯”å¦‚è¢«åˆ äº†ï¼‰ï¼Œé‡ç½®ä¸ºé»˜è®¤
        if (!globalData.users[globalData.currentUser]) {
            globalData.currentUser = Object.keys(globalData.users)[0];
        }
        database = globalData.users[globalData.currentUser];

        // 2. åˆ·æ–°ç•Œé¢æ˜¾ç¤ºçš„åå­—
        document.getElementById('home-username').innerText = globalData.currentUser;

        // 3. è¯»å– JSON (æ³¨æ„ï¼šç°åœ¨è¯»è¿›æ¥çš„é¢˜åº“åªä¼šå­˜åˆ°å½“å‰å­è´¦å·é‡Œ)
        fetch('./tiku.json') 
            .then(res => {
                if(!res.ok) throw new Error("404");
                return res.json();
            })
            .then(serverData => {
                let hasNewData = false;
                for (let key in serverData) {
                    if (key === 'mistakes' || key === 'examHistory') continue;
                    database[key] = serverData[key];
                    hasNewData = true;
                }
                if (hasNewData) {
                    saveData();
                    updateHomeStats();
                }
            })
            .catch(err => console.log("æœªåŒæ­¥é¢˜åº“:", err));

        updateHomeStats();
    };

    // === ä¿å­˜é€»è¾‘ï¼šå­˜æ•´ä¸ªå¤§ä»“åº“ ===
    function saveData() { 
        // ç¡®ä¿å½“å‰æŒ‡é’ˆçš„æ•°æ®åŒæ­¥å›æ€»ä»“åº“ï¼ˆè™½ç„¶æ˜¯å¼•ç”¨ï¼Œä½†ä¸ºäº†ä¿é™©ï¼‰
        globalData.users[globalData.currentUser] = database;
        localStorage.setItem('exam_db_v2', JSON.stringify(globalData)); 
        updateHomeStats(); 
    }

    function updateHomeStats() { 
        document.getElementById('mistake-count-label').innerText = database.mistakes.length + " é¢˜å¾…å¤ä¹ "; 
    }

    // === è§†å›¾åˆ‡æ¢ ===
    function showView(id) { 
        document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active')); 
        document.getElementById(id).classList.add('active'); 
    }

    function goHome() { 
        if (mode === 'exam' && Object.keys(userAnswers).length > 0 && !confirm("è€ƒè¯•ä¸­é€”é€€å‡ºå°†ä¸ä¿å­˜è¿›åº¦ï¼Œç¡®å®šï¼Ÿ")) return; 
        stopTimer(); 
        showView('view-home'); 
    }


    // ====== ã€æ–°å¢æ ¸å¿ƒé€»è¾‘ï¼šé€‰é¡¹æ‰“ä¹±å¤„ç†ã€‘ ======
function randomizeOptions(originalList) {
    // 1. æ·±æ‹·è´ï¼Œé˜²æ­¢ä¿®æ”¹åŸå§‹é¢˜åº“ (éå¸¸é‡è¦ï¼)
    var list = JSON.parse(JSON.stringify(originalList));
    
    // 2. éå†å¤„ç†æ¯ä¸€é¢˜
    list.forEach(q => {
        // æ’é™¤åˆ¤æ–­é¢˜ï¼Œä¸”å¿…é¡»æœ‰é€‰é¡¹
        if (q.type === 'åˆ¤æ–­é¢˜' || !q.options || q.options.length < 2) return;

        // 3. æå–é€‰é¡¹å†…å®¹çš„æ˜ å°„è¡¨
        // åŸå§‹æ•°æ®é€šå¸¸æ˜¯ ["A. å†…å®¹1", "B. å†…å®¹2"...]
        // æˆ‘ä»¬éœ€è¦åˆ†ç¦»å‡ºçº¯å†…å®¹ï¼š{ "A": "å†…å®¹1", "B": "å†…å®¹2" ... }
        var contentMap = {};
        var validKeys = []; // å­˜ A, B, C, D...
        
        q.options.forEach(opt => {
            var key = opt.charAt(0); // 'A'
            // å…¼å®¹ "A. " æˆ– "A." æˆ– "A " ç­‰æ ¼å¼ï¼Œå–ç¬¬3ä¸ªå­—ç¬¦å¼€å§‹çš„å†…å®¹
            // å¦‚æœä½ çš„æ ¼å¼å¾ˆä¹±ï¼Œè¿™é‡Œå¯èƒ½éœ€è¦æ›´å¼ºçš„æ­£åˆ™ï¼Œä½† demo æ•°æ®ä¸€èˆ¬æ˜¯ "A. xxx"
            var content = opt.substring(2).trim(); 
            contentMap[key] = content;
            validKeys.push(key);
        });

        // 4. è·å–æ­£ç¡®ç­”æ¡ˆçš„â€œå†…å®¹â€åˆ—è¡¨
        // æ¯”å¦‚ç­”æ¡ˆæ˜¯ "AB"ï¼Œæˆ‘ä»¬è¦æ‰¾åˆ° Aå’ŒB å¯¹åº”çš„å…·ä½“æ–‡å­—
        var correctContents = [];
        var oldAns = q.answer || "";
        for (var i = 0; i < oldAns.length; i++) {
            var k = oldAns.charAt(i);
            if (contentMap[k]) correctContents.push(contentMap[k]);
        }

        // 5. æå–æ‰€æœ‰é€‰é¡¹å†…å®¹å¹¶æ‰“ä¹±
        var allContents = Object.values(contentMap);
        // ä½¿ç”¨ç®€å•çš„æ´—ç‰Œç®—æ³•
        allContents.sort(() => Math.random() - 0.5);

        // 6. é‡ç»„é€‰é¡¹ å’Œ é‡ç®—ç­”æ¡ˆ
        var newOptions = [];
        var newAnsKeys = [];

        // è¿™é‡Œçš„ validKeys æ˜¯ ['A', 'B', 'C'...]ï¼ŒæŒ‰é¡ºåºèµ‹äºˆç»™æ‰“ä¹±åçš„å†…å®¹
        allContents.forEach((content, index) => {
            var newKey = validKeys[index]; // æ–°çš„ä½ç½®æ ‡å·ï¼Œæ¯”å¦‚ 0å·ä½å°±æ˜¯ A
            
            // ç”Ÿæˆæ–°é€‰é¡¹å­—ç¬¦ä¸² "A. å†…å®¹"
            newOptions.push(newKey + ". " + content);

            // æ£€æŸ¥è¿™ä¸ªå†…å®¹æ˜¯ä¸æ˜¯åŸæ¥çš„æ­£ç¡®ç­”æ¡ˆä¹‹ä¸€
            if (correctContents.includes(content)) {
                newAnsKeys.push(newKey);
            }
        });

        // 7. æ›´æ–°é¢˜ç›®å¯¹è±¡
        q.options = newOptions;
        // é‡æ–°æ’åºç­”æ¡ˆå­—æ¯ (æ¯”å¦‚ B A å˜æˆ A B)
        q.answer = newAnsKeys.sort().join('');
    });

    return list;
    }







    // ====== ã€æ ¸å¿ƒé€»è¾‘ï¼šå¼€å§‹ç­”é¢˜ã€‘ ======
function startQuiz(list, title, m, duration = 0) {
    // 1. å¤„ç†é€‰é¡¹ä¹±åº
    // å¦‚æœå…¨å±€å¼€å…³ isOptionShuffle ä¸º trueï¼Œåˆ™å¯¹é¢˜ç›®åˆ—è¡¨è¿›è¡Œæ·±æ‹·è´å’Œæ´—ç‰Œ
    if (typeof isOptionShuffle !== 'undefined' && isOptionShuffle) {
        currentQuizList = randomizeOptions(list);
    } else {
        currentQuizList = list; 
    }

    // 2. åˆå§‹åŒ–çŠ¶æ€
    currentIndex = 0; 
    mode = m; 
    userAnswers = {}; 
    submittedQuestions = {}; // æ¸…ç©ºâ€œå·²æäº¤â€çŠ¶æ€
    secondsElapsed = 0;
    
    // 3. æ›´æ–°ç•Œé¢æ ‡é¢˜å’Œæ¨¡å¼ç±»
    document.getElementById('quiz-mode-title').innerText = title; 
    document.getElementById('view-quiz').className = 'view-section active mode-' + m; 
    
    // 4. æ§åˆ¶åº•éƒ¨æŒ‰é’®çš„æ˜¾ç¤º/éšè—
    var btnTop = document.getElementById('btn-top-finish');
    var btnSubmit = document.getElementById('btn-submit');
    var btnNext = document.getElementById('btn-next');
    var btnKill = document.getElementById('btn-kill');

    if (mode === 'exam') {
        // --- è€ƒè¯•æ¨¡å¼ ---
        if(btnTop) btnTop.style.display = 'block'; // é¡¶éƒ¨äº¤å·
        if(btnKill) btnKill.style.display = 'none'; // è€ƒè¯•ä¸èƒ½åˆ é¢˜
        if(btnSubmit) btnSubmit.style.display = 'none'; // è€ƒè¯•ä¸æ˜¾ç¤ºæäº¤å•é¢˜
        if(btnNext) btnNext.style.display = 'block'; // æ˜¾ç¤ºä¸‹ä¸€é¢˜
        
        // å¼€å¯å€’è®¡æ—¶
        startTimer('down', duration); 
    } else {
        // --- ç»ƒä¹ æ¨¡å¼ / é”™é¢˜æ¨¡å¼ ---
        if(btnTop) btnTop.style.display = 'none'; 
        if(btnNext) btnNext.style.display = 'none'; 
        
        if(btnSubmit) {
            btnSubmit.style.display = 'block'; 
            btnSubmit.onclick = submitAnswer; // ç¡®ä¿äº‹ä»¶ç»‘å®šæ­£ç¡®
        }
        
        // é”™é¢˜æ¨¡å¼æ˜¾ç¤ºâ€œç§»é™¤â€æŒ‰é’®
        if (mode === 'mistake' && btnKill) btnKill.style.display = 'block'; 
        else if (btnKill) btnKill.style.display = 'none';

        // å¼€å¯æ­£å‘è®¡æ—¶
        startTimer('up'); 
    }

    // 5. åˆ‡æ¢è§†å›¾å¹¶æ¸²æŸ“ç¬¬ä¸€é¢˜
    showView('view-quiz'); 
    renderQuestion();
    }

    // === æ¸²æŸ“é¢˜ç›® ===
    function renderQuestion() {
    closeAIInline(); // åˆ‡æ¢é¢˜ç›®æ—¶è‡ªåŠ¨æ”¶èµ· AI è§£æé¢æ¿

    var q = currentQuizList[currentIndex];
    var userAnswer = userAnswers[currentIndex] || "";
    // åˆ¤æ–­å½“å‰é¢˜ç›®æ˜¯å¦åœ¨ç»ƒä¹ æˆ–é”™é¢˜æ¨¡å¼ä¸‹å·²ç»ç‚¹å‡»è¿‡â€œæäº¤â€
    var isSubmitted = (mode !== 'exam' && submittedQuestions[currentIndex]);

    // 1. æ›´æ–°è¿›åº¦å’Œé¢˜å·
    document.getElementById('q-index').innerText = (currentIndex + 1) + "/" + currentQuizList.length;
    document.getElementById('progress-fill').style.width = ((currentIndex + 1) / currentQuizList.length * 100) + "%";
    
    // 2. æ›´æ–°é¢˜ç›®ç±»å‹æ ‡ç­¾
    var typeBadge = q.type === 'åˆ¤æ–­é¢˜' ? 'badge-judge' : (q.type === 'å¤šé€‰é¢˜' ? 'badge-multi' : 'badge-single');
    document.getElementById('q-type').className = 'badge ' + typeBadge;
    document.getElementById('q-type').innerText = q.type.replace('é¢˜','');
    
    // 3. æ¸²æŸ“é¢˜ç›®æ–‡æœ¬
    document.getElementById('q-text').innerText = q.id + ". " + q.text;
    
    // 4. æ¸²æŸ“é€‰é¡¹åˆ—è¡¨
    var optsDiv = document.getElementById('q-options'); 
    optsDiv.innerHTML = '';
    var opts = (q.type === 'åˆ¤æ–­é¢˜' && (!q.options || q.options.length===0)) ? ["A. å¯¹", "B. é”™"] : q.options;
    
    opts.forEach(o => {
        var key = o.charAt(0);
        var el = document.createElement('div'); 
        el.className = 'option-item';
        el.innerHTML = `<span class="opt-tag">${key}</span> ${o.substring(2)}`;
        
        // é€‰ä¸­æ€å¤„ç†
        if (userAnswer.includes(key)) el.classList.add('selected');
        
        // åˆ¤å®šæ€å¤„ç†ï¼ˆæ­£ç¡®/é”™è¯¯é¢œè‰²æ˜¾ç¤ºï¼‰
        if (isSubmitted) { 
            if (q.answer.includes(key)) el.classList.add('correct'); // æ­£ç¡®é¡¹å˜ç»¿
            if (userAnswer.includes(key) && !q.answer.includes(key)) el.classList.add('wrong'); // é”™é€‰é¡¹å˜çº¢
        }
        
        el.onclick = () => handleOptionClick(el, key, q.type); 
        optsDiv.appendChild(el);
    });
    
    // 5. åº•éƒ¨æŒ‰é’®é€»è¾‘æ§åˆ¶
    var btnNext = document.getElementById('btn-next');
    var btnSubmit = document.getElementById('btn-submit');
    var btnKill = document.getElementById('btn-kill');
    var feedback = document.getElementById('feedback');
    
    if (mode === 'exam') {
        // --- è€ƒè¯•æ¨¡å¼ ---
        btnSubmit.style.display = 'none';
        btnKill.style.display = 'none';
        btnNext.style.display = 'block';
        btnNext.innerText = (currentIndex === currentQuizList.length - 1) ? "äº¤å·" : "ä¸‹ä¸€é¢˜"; 
        btnNext.onclick = (currentIndex === currentQuizList.length - 1) ? finishExam : () => nav(1); 
        feedback.innerText = "";
    } else {
        // --- ç»ƒä¹ æ¨¡å¼ (practice) æˆ– é”™é¢˜æ¨¡å¼ (mistake) ---
        if (isSubmitted) { 
            // å·²ç‚¹å‡»æäº¤ï¼šæ˜¾ç¤ºç­”æ¡ˆåé¦ˆï¼Œæ˜¾ç¤ºâ€œä¸‹ä¸€é¢˜â€ï¼Œéšè—â€œæäº¤â€
            var isRight = (userAnswer === q.answer); 
            feedback.innerHTML = isRight ? "<span style='color:var(--success)'>å›ç­”æ­£ç¡®</span>" : `ç­”æ¡ˆ: ${q.answer}`;
            btnSubmit.style.display = 'none'; 
            btnNext.style.display = 'block'; 
            btnNext.innerText = "ä¸‹ä¸€é¢˜"; 
            btnNext.onclick = () => nav(1);
        } else { 
            // æœªç‚¹å‡»æäº¤ï¼šæ˜¾ç¤ºâ€œæäº¤â€æŒ‰é’®ï¼Œéšè—â€œä¸‹ä¸€é¢˜â€
            feedback.innerText = "";
            btnSubmit.style.display = 'block'; 
            btnSubmit.onclick = submitAnswer; // æ˜¾å¼ç»‘å®šæäº¤äº‹ä»¶
            btnNext.style.display = 'none'; 
        }
        
        // é”™é¢˜æ¨¡å¼ä¸‹å§‹ç»ˆæ˜¾ç¤ºâ€œç§»é™¤â€æŒ‰é’®
        if (mode === 'mistake') {
            btnKill.style.display = 'block';
        } else {
            btnKill.style.display = 'none';
        }
    }
    }


    function toggleOptionShuffle() {
    isOptionShuffle = !isOptionShuffle;
    var btn = document.getElementById('btn-shuffle-opt');
    var icon = document.getElementById('icon-shuffle');
    
    if (isOptionShuffle) {
        btn.style.background = 'var(--light-coffee)';
        btn.style.borderColor = 'var(--primary)';
        btn.style.color = 'var(--primary)';
        btn.innerHTML = '<i>ğŸ”€</i> é€‰é¡¹ä¹±åº: å¼€';
    } else {
        btn.style.background = '#fcfaf8';
        btn.style.borderColor = 'var(--border-color)';
        btn.style.color = '#6d5d53';
        btn.innerHTML = '<i>â¬œ</i> é€‰é¡¹ä¹±åº: å…³';
    }
    }

    function handleOptionClick(el, key, type) {
    // å¦‚æœæ˜¯ç»ƒä¹ æ¨¡å¼ä¸”å·²ç»æäº¤è¿‡äº†ï¼Œç¦æ­¢å†æ¬¡ç‚¹å‡»ä¿®æ”¹
    if (mode === 'practice' && submittedQuestions[currentIndex]) return;
    
    var currentAns = userAnswers[currentIndex] || "";
    
    if (type === 'å¤šé€‰é¢˜') { 
        // å¤šé€‰é¢˜ï¼šç‚¹å‡»åˆ‡æ¢é€‰ä¸­çŠ¶æ€
        if (currentAns.includes(key)) { 
            currentAns = currentAns.replace(key, ''); 
        } else { 
            currentAns += key; 
        } 
        userAnswers[currentIndex] = currentAns.split('').sort().join(''); 
        renderQuestion(); // ç«‹å³é‡æ–°æ¸²æŸ“ï¼Œè®©é€‰é¡¹å˜è‰²
    } else { 
        // å•é€‰é¢˜/åˆ¤æ–­é¢˜
        userAnswers[currentIndex] = key; 
        
        // å¦‚æœæ˜¯æŒ‰å¥—åˆ·é¢˜ï¼ˆç»ƒä¹ æ¨¡å¼ï¼‰ï¼Œç‚¹å‡»å•é€‰åè‡ªåŠ¨è§†ä¸ºâ€œæäº¤â€ï¼Œç«‹å³çœ‹å¯¹é”™
        if (mode === 'practice') {
            submitAnswer();
        } else {
            // è€ƒè¯•æ¨¡å¼æˆ–é”™é¢˜æ¨¡å¼ï¼Œä»…æ¸²æŸ“é€‰ä¸­æ•ˆæœï¼Œä¸è‡ªåŠ¨åˆ¤å®šå¯¹é”™
            renderQuestion();
        }
    }
    }

    function submitAnswer() {
    // 1. è·å–å½“å‰ç”¨æˆ·çš„ç­”æ¡ˆ
    var ans = userAnswers[currentIndex]; 
    
    // 2. æ ¡éªŒï¼šå¦‚æœæ²¡æœ‰é€‰ç­”æ¡ˆï¼Œæç¤ºç”¨æˆ·
    if (!ans) {
        alert("è¯·å…ˆé€‰æ‹©ç­”æ¡ˆåå†æäº¤");
        return;
    }
    
    // 3. æ ‡è®°å½“å‰é¢˜ä¸ºâ€œå·²æäº¤â€çŠ¶æ€ (ç”¨äº renderQuestion æ˜¾ç¤ºçº¢ç»¿åˆ¤æ–­)
    submittedQuestions[currentIndex] = true;

    // 4. è·å–é¢˜ç›®å¯¹è±¡å’Œåˆ¤å®šç»“æœ
    var q = currentQuizList[currentIndex];
    var isCorrect = (ans === q.answer);
    
    // === é€»è¾‘ Aï¼šç»ƒä¹ æ¨¡å¼ (Practice) - ç­”é”™åŠ å…¥é”™é¢˜æœ¬ ===
    if (!isCorrect && mode === 'practice') { 
        // æŸ¥é‡ï¼šå¦‚æœé”™é¢˜æœ¬é‡Œæ²¡è¿™é“é¢˜ï¼Œæ‰æ·»åŠ 
        if (!database.mistakes.some(m => m.text === q.text)) { 
            database.mistakes.push(q); 
            saveData(); 
        } 
    }

    // === é€»è¾‘ Bï¼šé”™é¢˜æ¨¡å¼ (Mistake) - ç­”å¯¹è‡ªåŠ¨ç§»é™¤ (æ–°å¢åŠŸèƒ½) ===
    var autoRemovedMsg = ""; // ç”¨äºå­˜å‚¨ç§»é™¤æˆåŠŸçš„æç¤ºæ–‡å­—
    
    // è§¦å‘æ¡ä»¶ï¼šé”™é¢˜æ¨¡å¼ + å›ç­”æ­£ç¡® + å¼€å…³å·²å¼€å¯(isAutoRemoveMistakes)
    if (mode === 'mistake' && isCorrect && typeof isAutoRemoveMistakes !== 'undefined' && isAutoRemoveMistakes) {
        var initialLen = database.mistakes.length;
        
        // æ‰§è¡Œåˆ é™¤ï¼šä¿ç•™é‚£äº›æ–‡æœ¬ä¸åŒ¹é…çš„é¢˜ç›® (å³ç§»é™¤å½“å‰é¢˜)
        database.mistakes = database.mistakes.filter(m => m.text !== q.text);
        
        // å¦‚æœé•¿åº¦ç¡®å®å˜å°äº†ï¼Œè¯´æ˜ç§»é™¤æˆåŠŸ
        if (database.mistakes.length < initialLen) {
            saveData(); // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            // å‡†å¤‡æç¤ºè¯­
            autoRemovedMsg = "<span style='font-size:12px; color:#999; margin-left:8px; font-weight:normal;'>(å·²è‡ªåŠ¨æ–©æ€ ğŸ—‘ï¸)</span>";
        }
    }
    
    // 5. é‡æ–°æ¸²æŸ“ç•Œé¢ (æ˜¾ç¤ºæ­£ç¡®/é”™è¯¯é¢œè‰²ï¼Œæ˜¾ç¤ºè§£æç­‰)
    renderQuestion();

    // 6. è¿½åŠ â€œè‡ªåŠ¨ç§»é™¤â€çš„æç¤º (å› ä¸º renderQuestion ä¼šé‡ç½® feedbackï¼Œæ‰€ä»¥è¦åœ¨å®ƒä¹‹åè¿½åŠ )
    if (autoRemovedMsg) {
        var fb = document.getElementById('feedback');
        if (fb) {
            fb.innerHTML += autoRemovedMsg;
        }
    }
    }

    function toggleAutoRemove(el) {
    isAutoRemoveMistakes = el.checked;
    console.log("è‡ªåŠ¨ç§»é™¤æ¨¡å¼: " + (isAutoRemoveMistakes ? "å¼€å¯" : "å…³é—­"));
    }

    function nav(dir) { 
        if (dir === 1 && currentIndex < currentQuizList.length - 1) { currentIndex++; renderQuestion(); } 
        else if (dir === -1 && currentIndex > 0) { currentIndex--; renderQuestion(); } 
    }
    
    function jumpTo() { 
        var val = parseInt(document.getElementById('jump-val').value); 
        if (val >= 1 && val <= currentQuizList.length) { currentIndex = val - 1; renderQuestion(); } 
    }
    
    // === ç­”é¢˜å¡é€»è¾‘ ===

    function openQuestionCard() {
        var grid = document.getElementById('question-card-grid');
        grid.innerHTML = ''; // æ¸…ç©ºæ—§å†…å®¹
        
        // åŠ¨æ€ç”Ÿæˆæ–¹æ ¼
        currentQuizList.forEach((q, index) => {
            var item = document.createElement('div');
            item.className = 'card-item';
            item.innerText = index + 1;
            
            // çŠ¶æ€åˆ¤æ–­
            var isCurrent = (index === currentIndex);
            var isAnswered = userAnswers[index] !== undefined && userAnswers[index] !== "";
            
            if (isCurrent) {
                item.classList.add('current');
            } else if (isAnswered) {
                item.classList.add('done');
            }
            
            // å¦‚æœæ˜¯è€ƒè¯•æ¨¡å¼ï¼Œéœ€è¦æŠŠå®¹å™¨æ ‡è®°ä¸€ä¸‹ï¼Œä»¥ä¾¿CSSå˜è‰²
            if (mode === 'exam') {
                grid.classList.add('mode-exam');
            } else {
                grid.classList.remove('mode-exam');
            }

            // ç‚¹å‡»äº‹ä»¶
            item.onclick = function() {
                currentIndex = index;
                renderQuestion();
                closeQuestionCard();
            };
            
            grid.appendChild(item);
        });
        
        document.getElementById('card-modal').style.display = 'flex';
    }

    function closeQuestionCard() {
        document.getElementById('card-modal').style.display = 'none';
    }


    function finishExam() {
        stopTimer(); 
        
        var correct = 0, wrong = 0, score = 0, currentMistakes = [];
        
        currentQuizList.forEach((q, idx) => { 
            var uAns = userAnswers[idx] || ""; 
            if (uAns === q.answer) { 
                correct++; 
                score += (q.point || 1); 
            } else { 
                wrong++; 
                currentMistakes.push(Object.assign({}, q)); 
                if (!database.mistakes.some(m => m.text === q.text)) database.mistakes.push(q); 
            } 
        });
        
        if (!database.examHistory) database.examHistory = [];

        if (currentMistakes.length > 0 && mode === 'exam') { 
            var record = { 
                id: Date.now(), 
                date: new Date().toLocaleString(), 
                score: score, 
                mistakes: currentMistakes 
            }; 
            database.examHistory.unshift(record); 
            if (database.examHistory.length > 20) database.examHistory.pop(); 
            saveData(); 
        }
        
        document.getElementById('res-score').innerText = (mode === 'exam') ? score : "--"; 
        document.getElementById('res-correct').innerText = correct; 
        document.getElementById('res-wrong').innerText = wrong; 
        document.getElementById('res-time-taken').innerText = "è€—æ—¶: " + formatTime(secondsElapsed);
        
        var hintDiv = document.getElementById('res-mistake-hint');
        if (mode === 'exam' && currentMistakes.length > 0) { 
            hintDiv.style.display = 'block'; 
            hintDiv.innerText = `å·²å°† ${currentMistakes.length} é“é”™é¢˜ä¿å­˜è‡³[é”™é¢˜æ”»åš]ï¼Œè¯·å‰å¾€æŸ¥çœ‹è§£æã€‚`; 
        } else hintDiv.style.display = 'none';
        
        document.getElementById('result-modal').style.display = 'flex';
    }

    function startTimer(dir, limitMins) { 
        stopTimer(); 
        var display = document.getElementById('timer-display'); 
        display.classList.remove('urgent'); 
        
        if (dir === 'down' && limitMins > 0) { 
            secondsRemaining = limitMins * 60; 
            display.innerText = formatTime(secondsRemaining); 
            timerInterval = setInterval(() => { 
                secondsRemaining--; 
                secondsElapsed++; 
                display.innerText = formatTime(secondsRemaining); 
                if (secondsRemaining <= 60) display.classList.add('urgent'); 
                if (secondsRemaining <= 0) { 
                    finishExam(); 
                    alert("æ—¶é—´åˆ°ï¼Œè‡ªåŠ¨äº¤å·ï¼"); 
                } 
            }, 1000); 
        } else { 
            secondsElapsed = 0; 
            display.innerText = "00:00"; 
            timerInterval = setInterval(() => { 
                secondsElapsed++; 
                display.innerText = formatTime(secondsElapsed); 
            }, 1000); 
        } 
    }
    
    function stopTimer() { clearInterval(timerInterval); }
    
    function formatTime(s) { 
        var m = Math.floor(s/60); 
        var sec = s%60; 
        return (m<10?"0"+m:m) + ":" + (sec<10?"0"+sec:sec); 
    }
    
    function shuffle(a) { return a.sort(() => Math.random() - 0.5); }

    function openMistakeSelector() {
        if (database.mistakes.length === 0 && (!database.examHistory || database.examHistory.length === 0)) { 
            alert("æš‚æ— é”™é¢˜è®°å½•"); 
            return; 
        }
        document.getElementById('total-mistakes-num').innerText = database.mistakes.length; 
        var listDiv = document.getElementById('mistake-session-list'); 
        listDiv.innerHTML = "";
        
        if (database.examHistory) {
            database.examHistory.forEach((record, index) => { 
                var div = document.createElement('div'); 
                div.className = 'session-card'; 
                
                // ã€ä¿®æ”¹ã€‘ä½¿ç”¨äº† Flex å¸ƒå±€æ¥æ”¾ç½®åˆ é™¤æŒ‰é’®
                div.innerHTML = `
                    <div style="flex:1" onclick="startMistakeSession(${index})">
                        <div class="session-date">ğŸ“… ${record.date}</div>
                        <div class="session-info">å¾—åˆ†: ${record.score} Â· é”™é¢˜: ${record.mistakes.length}</div>
                    </div>
                    <div style="display:flex; align-items:center; gap:10px;">
                         <span class="session-count" onclick="startMistakeSession(${index})">${record.mistakes.length} é¢˜</span>
                         <button onclick="deleteMistakeSession(event, ${index})" style="border:1px solid #ffcccc; background:#fff5f5; color:red; border-radius:4px; padding:4px 8px; font-size:12px; cursor:pointer;">ğŸ—‘ï¸</button>
                    </div>
                `;
                listDiv.appendChild(div); 
            });
        }
        document.getElementById('mistake-select-modal').style.display = 'flex';
    }
    
    function closeMistakeSelector() { document.getElementById('mistake-select-modal').style.display = 'none'; }
    

    // === æ–°å¢ï¼šåˆ é™¤æ•´å¥—é”™é¢˜è®°å½• ===
    // === åˆ é™¤æ•´å¥—é”™é¢˜è®°å½•ï¼ˆå¹¶åŒæ­¥æ¸…ç†æ€»é”™é¢˜åº“ï¼‰ ===
    function deleteMistakeSession(e, index) {
        // é˜»æ­¢ç‚¹å‡»å†’æ³¡
        e.stopPropagation();
        
        // 1. è·å–è¦åˆ é™¤çš„é‚£æ¡è®°å½•
        var record = database.examHistory[index];
        var count = record.mistakes ? record.mistakes.length : 0;

        // æç¤ºè¯­å˜å¾—æ›´ä¸¥è‚ƒä¸€ç‚¹ï¼Œå‘ŠçŸ¥ç”¨æˆ·ä¼šè¿å¸¦åˆ é™¤
        if (confirm(`ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ\n\nâš ï¸ è­¦å‘Šï¼šè¿™å°†åŒæ—¶ä»ã€é”™é¢˜æ”»åšã€‘æ€»åº“ä¸­ç§»é™¤è¿™ ${count} é“é¢˜ç›®ï¼\n(å¦‚æœè¿™äº›é¢˜åœ¨å…¶ä»–åœºæ¬¡ä¹Ÿé”™è¿‡ï¼Œä¹Ÿä¼šä¸€å¹¶è¢«ç§»é™¤)`)) {
            
            // 2. æ ¸å¿ƒé€»è¾‘ï¼šä»æ€»é”™é¢˜åº“ä¸­ç§»é™¤è¿™äº›é¢˜
            if (record && record.mistakes && record.mistakes.length > 0) {
                // æå–è¿™æ‰¹è¦åˆ é™¤çš„é¢˜ç›®çš„å†…å®¹
                // æˆ‘ä»¬ç”¨é¢˜ç›®æ–‡æœ¬(text)ä½œä¸ºå”¯ä¸€æ ‡è¯†æ¥åŒ¹é…
                var textsToRemove = record.mistakes.map(m => m.text);
                
                // è¿‡æ»¤ database.mistakesï¼Œåªä¿ç•™é‚£äº›â€œä¸åœ¨åˆ é™¤åˆ—è¡¨é‡Œâ€çš„é¢˜
                database.mistakes = database.mistakes.filter(m => !textsToRemove.includes(m.text));
            }

            // 3. åˆ é™¤å†å²è®°å½•æœ¬èº«
            database.examHistory.splice(index, 1);
            
            // 4. ä¿å­˜å¹¶åˆ·æ–°
            saveData();
            updateHomeStats();      // åˆ·æ–°é¦–é¡µçš„â€œXé¢˜å¾…å¤ä¹ â€æ•°å­—
            openMistakeSelector();  // åˆ·æ–°å½“å‰çš„åˆ—è¡¨å¼¹çª—
        }
    }


    function startAllMistakes() { 
        if (database.mistakes.length === 0) return; 
        closeMistakeSelector(); 
        startQuiz(database.mistakes, "å…¨é‡é”™é¢˜æ”»åš", "mistake"); 
    }
    
    function startMistakeSession(index) { 
        var record = database.examHistory[index]; 
        if (!record) return; 
        closeMistakeSelector(); 
        startQuiz(record.mistakes, "é”™é¢˜å›é¡¾ (" + record.date.split(' ')[0] + ")", "mistake"); 
    }
    
    function killMistake() { 
        var q = currentQuizList[currentIndex]; 
        database.mistakes = database.mistakes.filter(m => m.text !== q.text); 
        saveData(); 
        alert("å·²ä»æ€»é”™é¢˜åº“ä¸­ç§»é™¤"); 
        nav(1); 
    }
    
    // === è€ƒè¯•é…ç½® ===
    function openRandomConfig() { document.getElementById('config-modal').style.display = 'flex'; renderSetCheckboxes(); updateTotal(); }
    function closeRandomConfig() { document.getElementById('config-modal').style.display = 'none'; }
    
    function renderSetCheckboxes() { 
        var area = document.getElementById('set-selection-area'); 
        area.innerHTML = ''; 
        var keys = Object.keys(database).filter(k => k !== 'mistakes' && k !== 'examHistory').sort((a,b)=>parseInt(a)-parseInt(b)); 
        keys.forEach(k => { 
            var d = document.createElement('label'); 
            d.style.display="flex"; d.style.alignItems="center"; d.style.fontSize="13px"; 
            d.innerHTML = `<input type="checkbox" value="${k}" checked onchange="updateTotal()"> ç¬¬${k}å¥—`; 
            area.appendChild(d); 
        }); 
    }
    
    function toggleAllSets(state) { 
        document.querySelectorAll('#set-selection-area input').forEach(c => c.checked = state); 
        updateTotal(); 
    }
    
    function updateTotal() { 
        var j=v('cfg-judge'), s=v('cfg-single'), m=v('cfg-multi'), jp=v('pts-judge'), sp=v('pts-single'), mp=v('pts-multi'); 
        document.getElementById('cfg-total-count').innerText = (parseInt(j)+parseInt(s)+parseInt(m)); 
        document.getElementById('cfg-total-score').innerText = (j*jp + s*sp + m*mp); 
    }
    
    function v(id) { return parseFloat(document.getElementById(id).value) || 0; }
    
    function startRandomExam() {
        var sets = []; 
        document.querySelectorAll('#set-selection-area input:checked').forEach(c => sets.push(c.value)); 
        if (sets.length===0) { alert("è¯·é€‰æ‹©é¢˜åº“"); return; }
        
        var pool = { j:[], s:[], m:[] }, jp=v('pts-judge'), sp=v('pts-single'), mp=v('pts-multi');
        sets.forEach(k => { 
            database[k].forEach(q => { 
                var newQ = Object.assign({}, q, {source: "ç¬¬"+k+"å¥—"}); 
                if (q.type==='åˆ¤æ–­é¢˜') { newQ.point=jp; pool.j.push(newQ); } 
                else if (q.type==='å•é€‰é¢˜') { newQ.point=sp; pool.s.push(newQ); } 
                else if (q.type==='å¤šé€‰é¢˜') { newQ.point=mp; pool.m.push(newQ); } 
            }); 
        });
        
        var jc=v('cfg-judge'), sc=v('cfg-single'), mc=v('cfg-multi');
        // ä¿®æ­£ï¼šç¡®ä¿ä¸ä¼šè¯·æ±‚è¶…è¿‡é¢˜åº“æ•°é‡çš„é¢˜ç›®
        var list = [].concat(
            shuffle(pool.j).slice(0, Math.min(jc, pool.j.length)), 
            shuffle(pool.s).slice(0, Math.min(sc, pool.s.length)), 
            shuffle(pool.m).slice(0, Math.min(mc, pool.m.length))
        );
        
        if(list.length===0) { alert("æ²¡æœ‰è¶³å¤Ÿçš„é¢˜ç›®"); return; } 
        list.forEach((q,i) => q.id = i+1); 
        
        var duration = parseInt(document.getElementById('cfg-duration').value) || 0; 
        closeRandomConfig(); 
        startQuiz(list, "æ¨¡æ‹Ÿè€ƒè¯•", "exam", duration);
    }

    // === ç™»å½•é€»è¾‘ ===
    const APP_USER = "ycaviar", APP_PWD = "060202";
    
    // ä¿®æ”¹åçš„åˆå§‹åŒ–å‡½æ•°ï¼šæ¯æ¬¡åŠ è½½é¡µé¢éƒ½å¼ºåˆ¶é‡ç½®
    (function initLogin() {
        // 1. å¼ºåˆ¶æ¸…é™¤æµè§ˆå™¨ç¼“å­˜çš„ç™»å½•çŠ¶æ€
        sessionStorage.removeItem('is_logged_in');
        
        // 2. å¼ºåˆ¶æ˜¾ç¤ºç™»å½•å¼¹çª—
        document.getElementById('login-modal').style.display = 'flex';
        
        // 3. æ¸…ç©ºè¾“å…¥æ¡†ï¼ˆæå‡ä½“éªŒï¼Œé˜²æ­¢çœ‹åˆ°ä¸Šæ¬¡å¡«å†™çš„æ®‹ç•™ï¼‰
        document.getElementById('login-user').value = "";
        document.getElementById('login-pwd').value = "";
        
        // é‡ç½®é¦–é¡µçš„ç”¨æˆ·åä¸ºé»˜è®¤å€¼ï¼ˆç›´åˆ°ç™»å½•æˆåŠŸæ‰æ˜¾ç¤ºçœŸåï¼‰
        document.getElementById('home-username').innerText = "è€ƒç”Ÿ";
    })();
    
    // === ç™»å½•é€»è¾‘å®ç° ===
    function doLogin() {
        const userInp = document.getElementById('login-user').value.trim();
        const pwdInp = document.getElementById('login-pwd').value.trim();
        const msgDiv = document.getElementById('login-msg');

        

        if (userInp === APP_USER && pwdInp === APP_PWD) {
            // 1. è®°å½•ç™»å½•çŠ¶æ€åˆ° SessionStorage (å…³é—­æµè§ˆå™¨å¤±æ•ˆ)
            sessionStorage.setItem('is_logged_in', 'true');
            
            // 2. éšè—ç™»å½•å¼¹çª—
            document.getElementById('login-modal').style.display = 'none';
            
            // 3. æ›´æ–°ç•Œé¢æ˜¾ç¤ºçš„ç”¨æˆ·å
            // æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬é»˜è®¤ç™»å½•åä½¿ç”¨çš„æ˜¯ globalData.currentUser è®°å½•çš„å­˜æ¡£å
            document.getElementById('home-username').innerText = globalData.currentUser;
            
            // 4. æ¸…ç©ºè¾“å…¥æ¡†ä»¥ä¾¿ä¸‹æ¬¡å®‰å…¨
            document.getElementById('login-pwd').value = "";
            msgDiv.innerText = "";
            
            console.log("ç™»å½•æˆåŠŸï¼");
        } else {
            msgDiv.innerText = "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯";
            // å¢åŠ ä¸€ç‚¹éœ‡åŠ¨åé¦ˆæ•ˆæœï¼ˆå¯é€‰ï¼‰
            const card = document.querySelector('.login-card');
            card.style.animation = "none";
            setTimeout(() => card.style.animation = "pulse 0.3s", 10);
        }
    }

    // === é€€å‡ºç™»å½•é€»è¾‘ ===
    function doLogout() {
        if (confirm("ç¡®å®šè¦é”å®šç³»ç»Ÿå¹¶è¿”å›ç™»å½•é¡µå—ï¼Ÿ")) {
            // 1. æ¸…é™¤ä¼šè¯çŠ¶æ€
            sessionStorage.removeItem('is_logged_in');
            
            // 2. åˆ·æ–°é¡µé¢
            // å› ä¸ºä½ çš„ initLogin() å‡½æ•°å†™åœ¨é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ‰§è¡Œ
            // æ‰€ä»¥åˆ·æ–°é¡µé¢ä¼šè‡ªåŠ¨æ¸…é™¤æ‰€æœ‰æ•°æ®å¹¶å¼¹å‡ºç™»å½•æ¡†
            location.reload(); 
        }
    }

    // === å…¶ä»–ç•Œé¢é€»è¾‘ ===
    function goToSetSelection() { 
        var c = document.getElementById('set-list-container'); 
        c.innerHTML=''; 
        var keys = Object.keys(database).filter(k=>k!=='mistakes'&&k!=='examHistory').sort((a,b)=>parseInt(a)-parseInt(b)); 
        if(keys.length===0) c.innerHTML='<div style="text-align:center;color:#999;grid-column:1/-1">æš‚æ— é¢˜åº“</div>'; 
        keys.forEach(k => { 
            var d = document.createElement('div'); 
            d.className='set-card'; 
            d.innerHTML=`<div class="set-num">ç¬¬ ${k} å¥—</div><div class="set-info">${database[k].length} é¢˜</div>`; 
            d.onclick=()=>startQuiz(database[k], "ç¬¬"+k+"å¥—ç»ƒä¹ ", "practice"); 
            c.appendChild(d); 
        }); 
        showView('view-select'); 
    }
    
    function closeResultModal() { 
        document.getElementById('result-modal').style.display='none'; 
        showView('view-home'); 
    }
    
    function openImportModal() { document.getElementById('import-modal').style.display='flex'; onSetNumChange(); }
    function closeImportModal() { document.getElementById('import-modal').style.display='none'; }
    
    function onSetNumChange() {
        var num = document.getElementById('import-set-num').value;
        var list = database[num] || [];
        document.getElementById('preview-count').innerText = list.length;
        document.getElementById('preview-list').innerHTML = list.length ? "å·²å­˜åœ¨æ•°æ®ï¼Œä¿å­˜å°†è¦†ç›–" : "æš‚æ— æ•°æ®";
    }
    
    function deleteCurrentSet() {
        var num = document.getElementById('import-set-num').value;
        if (confirm("åˆ é™¤ç¬¬" + num + "å¥—?")) { delete database[num]; saveData(); onSetNumChange(); }
    }

    function importData() { 
        var set = document.getElementById('import-set-num').value;
        var qT = document.getElementById('raw-questions').value;
        var aT = document.getElementById('raw-answers').value; 
        
        if (!qT || !aT) { alert("è¯·è¾“å…¥å†…å®¹"); return; } 
        
        // --- 1. è§£æç­”æ¡ˆé€»è¾‘ (ä¿æŒä¸å˜) ---
        var ansMap = {}; 
        aT.split('\n').forEach(l => { 
            var p = l.indexOf(':'); if (p < 0) return; 
            var left = l.substring(0, p).trim(), right = l.substring(p + 1).trim();
            var s = parseInt(left), e = parseInt(left); 
            if (left.indexOf('~') > 0) { var pts = left.split('~'); s = parseInt(pts[0]); e = parseInt(pts[1]); } 
            if (!isNaN(s)) { 
                var ans = right.split(/\s+/).filter(x => x); 
                if (s === e && ans.length === 1) ansMap[s] = ans[0]; 
                else for (var j = 0; j <= e - s; j++) if (ans[j]) ansMap[s + j] = ans[j]; 
            } 
        }); 

        // --- 2. è§£æé¢˜ç›®é€»è¾‘ (æ ¸å¿ƒä¿®æ”¹éƒ¨åˆ†) ---
        var list = [], curQ = null;
        var currentType = "å•é€‰é¢˜"; // é»˜è®¤ç±»å‹ï¼Œå¦‚æœå¼€å¤´æ²¡æœ‰æ ‡é¢˜ï¼Œé»˜è®¤æŒ‰å•é€‰å¤„ç†

        qT.split('\n').forEach(l => { 
            l = l.trim(); 
            if (!l) return; 

            // === ä¿®æ”¹ç‚¹ Aï¼šæ£€æµ‹é¢˜å‹æ ‡é¢˜è¡Œ ===
            // åªè¦è¿™ä¸€è¡ŒåŒ…å«ç‰¹å®šå…³é”®è¯ï¼Œå°±åˆ‡æ¢æ¥ä¸‹æ¥çš„é¢˜ç›®ç±»å‹ï¼Œå¹¶è·³è¿‡è¿™ä¸€è¡Œ
            if (l.includes('åˆ¤æ–­é¢˜')) { currentType = 'åˆ¤æ–­é¢˜'; return; }
            if (l.includes('å•é€‰é¢˜')) { currentType = 'å•é€‰é¢˜'; return; }
            if (l.includes('å¤šé€‰é¢˜')) { currentType = 'å¤šé€‰é¢˜'; return; }

            // === æ£€æµ‹é¢˜ç›®å¼€å§‹ (æ•°å­— + ç‚¹) ===
            var dotIdx = l.indexOf('.'); 
            var potentialNum = parseInt(l.substring(0, dotIdx)); 
            
            // è¿™é‡Œçš„åˆ¤å®šç¨å¾®æ”¾å®½ä¸€ç‚¹ (dotIdx < 6) ä»¥é˜²é¢˜å·å¾ˆå¤§ (å¦‚ 100.)
            if (dotIdx > 0 && dotIdx < 6 && !isNaN(potentialNum)) { 
                if (curQ) list.push(curQ); 
                var id = potentialNum; 
                
                // === ä¿®æ”¹ç‚¹ Bï¼šç›´æ¥ä½¿ç”¨å½“å‰æ•æ‰åˆ°çš„ currentType ===
                // å–æ¶ˆäº†ä¹‹å‰çš„ if (id<=20) ... è¿™ç§ç¡¬ç¼–ç 
                curQ = { 
                    id: id, 
                    type: currentType, 
                    text: l.substring(dotIdx + 1).trim(), 
                    options: [], 
                    answer: ansMap[id] || '?' 
                }; 
            } 
            // === æ£€æµ‹é€‰é¡¹ (A. æˆ– Aã€ æˆ– (A) ç­‰å¸¸è§æ ¼å¼) ===
            // å…¼å®¹æ€§ä¼˜åŒ–ï¼šåªè¦å¼€å¤´æ˜¯ A-F ä¸”åé¢è·Ÿç‚¹æˆ–é¡¿å·ï¼Œéƒ½ç®—é€‰é¡¹
            else if (curQ && /^[A-F][\.\ã€]/.test(l)) { 
                curQ.options.push(l); 
            } 
            // === è¿½åŠ é¢˜ç›®æ–‡æœ¬ ===
            // æ’é™¤æ‰ä¸åŒ…å«é¡¿å·çš„æ™®é€šæ–‡æœ¬è¡Œï¼Œé˜²æ­¢æŠŠæœªè¯†åˆ«çš„æ ‡é¢˜è¡ŒåŠ è¿›å»
            // ä½†å¦‚æœçœŸçš„æ˜¯é¢˜ç›®æ¢è¡Œï¼Œè¿˜æ˜¯éœ€è¦åŠ è¿›å»çš„ã€‚
            else if (curQ) { 
                curQ.text += (" " + l); 
            } 
        }); 
        
        if (curQ) list.push(curQ); 
        
        database[set] = list; 
        saveData(); 
        alert("å¯¼å…¥æˆåŠŸï¼å·²æ ¹æ®æ ‡é¢˜è‡ªåŠ¨è¯†åˆ«é¢˜å‹ã€‚"); 
        closeImportModal(); 
    }
    
    function exportToFile() { 
        var a = document.createElement('a'); 
        a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(database)); 
        a.download = "é¢˜åº“å¤‡ä»½.json"; 
        document.body.appendChild(a); a.click(); a.remove(); 
    }
    
    function importFromFile(input) { 
        var file = input.files[0]; if (!file) return; 
        var reader = new FileReader(); 
        reader.onload = function(e) { 
            try { 
                var data = JSON.parse(e.target.result); 
                for(let key in data) { 
                    if (key === 'mistakes') { 
                        if (!database.mistakes) database.mistakes = []; 
                        data.mistakes.forEach(m => { if (!database.mistakes.some(em => em.text === m.text)) database.mistakes.push(m); }); 
                    } else if (key === 'examHistory') { 
                        if(!database.examHistory) database.examHistory = []; 
                        database.examHistory = data.examHistory.concat(database.examHistory); 
                    } else { 
                        database[key] = data[key]; 
                    } 
                } 
                saveData(); alert("æ¢å¤æˆåŠŸ"); input.value = ''; 
            } catch(e) { alert("æ–‡ä»¶é”™è¯¯"); } 
        }; 
        reader.readAsText(file); 
    }

    // === å­è´¦å·/å¤šå­˜æ¡£ç®¡ç† ===
    
    // === å­˜æ¡£ç®¡ç†ç³»ç»Ÿ ===

    function openArchiveManager() {
        showView('view-archive');
        renderArchiveList();
    }

    function renderArchiveList() {
        var container = document.getElementById('archive-list-container');
        container.innerHTML = "";
        
        var users = Object.keys(globalData.users);
        
        users.forEach(name => {
            var isCurrent = (name === globalData.currentUser);
            var userData = globalData.users[name];
            // ç»Ÿè®¡é”™é¢˜æ•°å’Œåšé¢˜è®°å½•æ•°
            var mistakeCount = userData.mistakes ? userData.mistakes.length : 0;
            var historyCount = userData.examHistory ? userData.examHistory.length : 0;
            
            var div = document.createElement('div');
            div.className = "archive-card";
            if (isCurrent) div.style.borderColor = "var(--primary)";
            
            div.innerHTML = `
                <div class="archive-info" onclick="switchArchive('${name}')">
                    <div class="archive-name">
                        ${name} 
                        ${isCurrent ? '<span class="tag-current">å½“å‰ä½¿ç”¨</span>' : ''}
                    </div>
                    <div class="archive-detail">é”™é¢˜: ${mistakeCount} | è®°å½•: ${historyCount}</div>
                </div>
                <div class="archive-actions">
                    <button class="btn-icon" onclick="renameArchive('${name}')">âœï¸</button>
                    ${name !== 'é»˜è®¤ç”¨æˆ·' ? `<button class="btn-icon btn-delete" onclick="deleteArchive('${name}')">ğŸ—‘ï¸</button>` : ''}
                </div>
            `;
            container.appendChild(div);
        });
    }

    function createNewArchive() {
        var name = prompt("è¯·è¾“å…¥æ–°å­˜æ¡£åç§°ï¼š");
        if (!name) return;
        name = name.trim();
        if (globalData.users[name]) {
            alert("è¯¥å­˜æ¡£åå·²å­˜åœ¨ï¼");
            return;
        }
        
        // åˆ›å»ºæ–°å­˜æ¡£
        globalData.users[name] = { mistakes: [], examHistory: [] };
        
        // ä¿å­˜
        if(confirm("åˆ›å»ºæˆåŠŸï¼æ˜¯å¦ç«‹å³åˆ‡æ¢åˆ°è¯¥å­˜æ¡£ï¼Ÿ")) {
            switchArchive(name);
        } else {
            saveData(); // ä»…ä¿å­˜ä¸åˆ‡æ¢
            renderArchiveList();
        }
    }

    function renameArchive(oldName) {
        if (oldName === 'é»˜è®¤ç”¨æˆ·') {
            alert("é»˜è®¤ç”¨æˆ·ä¸èƒ½é‡å‘½å");
            return;
        }
        
        var newName = prompt("è¯·è¾“å…¥æ–°åç§°ï¼š", oldName);
        if (!newName || newName === oldName) return;
        newName = newName.trim();
        
        if (globalData.users[newName]) {
            alert("è¯¥åç§°å·²å­˜åœ¨ï¼");
            return;
        }
        
        // æ ¸å¿ƒé€»è¾‘ï¼šæ•°æ®æ¬è¿
        var data = globalData.users[oldName]; // å–å‡ºæ—§æ•°æ®
        globalData.users[newName] = data;      // èµ‹äºˆæ–°åå­—
        delete globalData.users[oldName];      // åˆ é™¤æ—§åå­—
        
        // å¦‚æœæ”¹çš„æ˜¯å½“å‰æ­£åœ¨ç”¨çš„ç”¨æˆ·ï¼ŒæŒ‡é’ˆä¹Ÿè¦è·Ÿç€å˜
        if (globalData.currentUser === oldName) {
            globalData.currentUser = newName;
            document.getElementById('home-username').innerText = newName;
        }
        
        saveData();
        renderArchiveList();
    }

    function deleteArchive(name) {
        if (name === 'é»˜è®¤ç”¨æˆ·') return; // é˜²å¾¡æ€§æ£€æŸ¥
        
        if (confirm(`ç¡®å®šè¦å½»åº•åˆ é™¤å­˜æ¡£ [${name}] å—ï¼Ÿ\né‡Œé¢çš„é”™é¢˜å’Œè®°å½•å°†æ°¸ä¹…æ¶ˆå¤±ï¼`)) {
            // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰ç”¨æˆ·ï¼Œå…ˆåˆ‡å›é»˜è®¤ç”¨æˆ·
            if (globalData.currentUser === name) {
                alert("æ‚¨åˆ é™¤äº†å½“å‰æ­£åœ¨ä½¿ç”¨çš„å­˜æ¡£ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨åˆ‡æ¢å›é»˜è®¤ç”¨æˆ·ã€‚");
                switchArchive('é»˜è®¤ç”¨æˆ·'); // åˆ‡æ¢å‡½æ•°é‡Œä¼šè‡ªåŠ¨ä¿å­˜
                // switchArchive ä¼šåˆ·æ–°é¡µé¢ï¼Œæ‰€ä»¥ä¸‹é¢ä»£ç ä¸ç”¨æ‰§è¡Œäº†
            } else {
                delete globalData.users[name];
                saveData();
                renderArchiveList();
            }
        }
    }

    function switchArchive(name) {
        if (name === globalData.currentUser) {
            alert("å½“å‰å·²ç»æ˜¯è¿™ä¸ªå­˜æ¡£äº†");
            return;
        }
        
        // åˆ‡æ¢é€»è¾‘ï¼ˆå¤ç”¨ä¹‹å‰çš„ä¿®å¤ç‰ˆé€»è¾‘ï¼‰
        // 1. å…ˆä¿å­˜æ—§æ•°æ®
        saveData(); 
        
        // 2. åˆ‡æ¢æŒ‡é’ˆ
        globalData.currentUser = name;
        
        // 3. å¼ºåˆ¶å†™å…¥ç¡¬ç›˜ï¼ˆä¸ç»è¿‡ saveData æŒ‡é’ˆèµ‹å€¼ï¼Œé˜²æ­¢æ•°æ®æ±¡æŸ“ï¼‰
        localStorage.setItem('exam_db_v2', JSON.stringify(globalData));
        
        alert(`å·²åˆ‡æ¢åˆ° [${name}]`);
        location.reload(); // åˆ·æ–°é¡µé¢
    }

    // ==========================================
    // === AI åŠ©æ‰‹æ¨¡å— (DeepSeek ä¸“ç”¨ç‰ˆ) ===
    // ==========================================

    // é¢„è®¾ä½ çš„ Key (ä»…ç”¨äºé¦–æ¬¡è‡ªåŠ¨é…ç½®)
    const PRESET_KEY = "sk-a4ad4a834feb4dc5a74dfbd04588e364"; 

    // åˆå§‹åŒ–ï¼šæ£€æŸ¥æœ¬åœ°æ˜¯å¦æœ‰Keyï¼Œæ²¡æœ‰åˆ™è‡ªåŠ¨å¡«å…¥é¢„è®¾çš„
    (function initAI() {
        if (!localStorage.getItem('ai_api_key')) {
            localStorage.setItem('ai_api_key', PRESET_KEY);
            console.log("å·²è‡ªåŠ¨é…ç½® DeepSeek Key");
        }
    })();

    function openAIConfig() {
        // è¿™é‡Œçš„æ—§ä»£ç åˆ æ‰ï¼šdocument.getElementById('ai-result-modal').style.display = 'none';
        
        document.getElementById('ai-config-modal').style.display = 'flex';
        document.getElementById('ai-api-key').value = localStorage.getItem('ai_api_key') || "";
    }

    function saveAIConfig() {
        var key = document.getElementById('ai-api-key').value.trim();
        if(!key) { alert("Key ä¸èƒ½ä¸ºç©º"); return; }
        localStorage.setItem('ai_api_key', key);
        alert("é…ç½®å·²ä¿å­˜ï¼");
        document.getElementById('ai-config-modal').style.display = 'none';
    }

    function askAI() {
        // 1. æ£€æŸ¥ Key
        var key = localStorage.getItem('ai_api_key');
        if (!key) {
            openAIConfig();
            return;
        }
        
        // 2. æ˜¾ç¤ºåµŒå…¥å¼é¢æ¿ (ä¸å†æ˜¯å¼¹çª—)
        var box = document.getElementById('ai-inline-box');
        box.style.display = 'block';
        
        // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨ï¼Œç¡®ä¿ç”¨æˆ·çœ‹åˆ°è§£ææ¡†
        // setTimeout(() => box.scrollIntoView({behavior: "smooth"}), 100);
        
        // 3. å‘èµ·è¯·æ±‚
        requestAIExplanation();
    }


    function closeAIInline() {
        document.getElementById('ai-inline-box').style.display = 'none';
        document.getElementById('ai-content-area').innerHTML = ""; // æ¸…ç©ºå†…å®¹
    }


    async function requestAIExplanation() {
        var contentDiv = document.getElementById('ai-content-area');
        contentDiv.innerHTML = "<div style='color:#888;'>ğŸ§  æ­£åœ¨æ€è€ƒé¢˜ç›®ï¼Œè¿æ¥ DeepSeek ä¸­...</div>";
        
        // è·å–é¢˜ç›®ä¸Šä¸‹æ–‡
        var q = currentQuizList[currentIndex];
        var userAns = userAnswers[currentIndex] || "æœªä½œç­”";
        var isWrong = (userAns !== q.answer);

        // æ„é€  Prompt (æç¤ºè¯)
        
        var prompt = `ä½ æ˜¯ä¸€ä½æ‹¥æœ‰20å¹´æ•™å­¦ç»éªŒçš„èµ„æ·±æ”¿æ²»/ç†è®ºè¯¾è¾…å¯¼ä¸“å®¶ï¼Œæ“…é•¿å°†å¤æ‚çš„ç†è®ºæ¦‚å¿µé€šä¿—åŒ–ï¼Œå¹¶èƒ½æ•é”æ´å¯Ÿå­¦ç”Ÿçš„æ˜“é”™ç‚¹ã€‚

è¯·ä¸ºæˆ‘è¯¦ç»†è§£æè¿™é“é¢˜ç›®ï¼š

ã€é¢˜ç›®ä¿¡æ¯ã€‘
- é¢˜ç›®å†…å®¹ï¼š${q.text}
- é¢˜ç›®ç±»å‹ï¼š${q.type}
- é€‰é¡¹åˆ—è¡¨ï¼š
${q.options ? q.options.join('\n') : (q.type==='åˆ¤æ–­é¢˜'?'A. å¯¹\nB. é”™':'æ— ')}

ã€ç­”é¢˜æƒ…å†µã€‘
- æ­£ç¡®ç­”æ¡ˆï¼š${q.answer}
- è€ƒç”Ÿç­”æ¡ˆï¼š${userAns}
- ç­”é¢˜çŠ¶æ€ï¼š${isWrong ? 'âŒ å›ç­”é”™è¯¯' : 'âœ… å›ç­”æ­£ç¡®'}

---

è¯·æŒ‰ç…§ä»¥ä¸‹ 5 ä¸ªæ­¥éª¤è¿›è¡Œæ·±åº¦è¾…å¯¼ï¼ˆè¯·ä¸¥æ ¼ä½¿ç”¨Markdownæ ¼å¼ï¼Œå…³é”®æ¦‚å¿µåŠ ç²—ï¼‰ï¼š

### 1. ğŸ“– æ ¸å¿ƒè€ƒç‚¹
ç”¨ä¸€å¥è¯ç²¾å‡†æ¦‚æ‹¬è¿™é“é¢˜è€ƒæŸ¥çš„æ˜¯å“ªä¸ªç« èŠ‚çš„ä»€ä¹ˆçŸ¥è¯†ç‚¹ï¼ˆä¾‹å¦‚ï¼šâ€œæœ¬é¢˜è€ƒæŸ¥çš„æ˜¯å”¯ç‰©è¾©è¯æ³•ä¸­çš„è´¨é‡äº’å˜è§„å¾‹â€ï¼‰ã€‚

### 2. ğŸ’¡ æ·±åº¦è§£æï¼ˆæ­£ç¡®é¡¹ï¼‰
è¯¦ç»†è§£é‡Šä¸ºä»€ä¹ˆæ­£ç¡®ç­”æ¡ˆæ˜¯ **${q.answer}**ã€‚
- ç»“åˆåŸè‘—åŸç†æˆ–æ•™æåŸæ–‡è¿›è¡Œé˜è¿°ã€‚
- å¦‚æœæ˜¯æ—¶æ”¿é¢˜ï¼Œè¯·äº¤ä»£ç›¸å…³çš„èƒŒæ™¯æˆ–ä¼šè®®ç²¾ç¥ã€‚
- å¦‚æœæ˜¯é€»è¾‘é¢˜ï¼Œè¯·æ¨å¯¼å…¶é€»è¾‘é“¾æ¡ã€‚

### 3. ğŸ” å¹²æ‰°é¡¹è¾¨æï¼ˆé‡è¦ï¼‰
è¯·é€ä¸€åˆ†ææœªé€‰çš„é€‰é¡¹ï¼ˆç‰¹åˆ«æ˜¯é‚£äº›å…·æœ‰è¿·æƒ‘æ€§çš„é€‰é¡¹ï¼‰ï¼š
- å®ƒä»¬ä¸ºä»€ä¹ˆæ˜¯é”™çš„ï¼Ÿï¼ˆæ˜¯å¼ å† ææˆ´ã€è¿‡äºç»å¯¹ã€è¿˜æ˜¯æœ¬èº«è¯´æ³•é”™è¯¯ï¼Ÿï¼‰
- æŒ‡å‡ºè¿™äº›é€‰é¡¹é€šå¸¸æ˜¯åœ¨ä»€ä¹ˆæƒ…å†µä¸‹æ‰æˆç«‹ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ã€‚
${isWrong ? `**ç‰¹åˆ«åˆ†æ**ï¼šè€ƒç”Ÿé”™é€‰äº† ${userAns}ï¼Œè¯·é‡ç‚¹æŒ‡å‡ºè¯¥é€‰é¡¹çš„é™·é˜±åœ¨å“ªé‡Œï¼Œä»¥åŠè€ƒç”Ÿå¯èƒ½å­˜åœ¨çš„æ€ç»´è¯¯åŒºã€‚` : ''}

### 4. ğŸ§  è®°å¿†æŠ€å·§
- æä¾›ä¸€ä¸ªæ–¹ä¾¿è®°å¿†çš„å£è¯€ã€å…³é”®è¯æˆ–é€»è¾‘å›¾ç¤ºï¼Œå¸®åŠ©æˆ‘ä¸‹æ¬¡ä¸å†çŠ¯é”™ã€‚

### 5. ğŸ¯ ä¸¾ä¸€åä¸‰ï¼ˆç°åœºå‡ºé¢˜ï¼‰
ä¸ºäº†æ£€æµ‹æˆ‘æ˜¯å¦çœŸçš„æŒæ¡äº†è¯¥è€ƒç‚¹ï¼Œ**è¯·ç°åœºç¼–å†™ä¸€é“åŒç±»å‹çš„å˜å¼é¢˜ï¼ˆéš¾åº¦ç›¸å½“æˆ–ç•¥é«˜ï¼‰**ï¼š
> **ã€æ¨¡æ‹Ÿæ¼”ç»ƒã€‘** (è¿™é‡Œå†™ä½ å‡ºçš„æ–°é¢˜ç›®å†…å®¹)
> **ã€é€‰é¡¹ã€‘**
> A. ...
> B. ...
> C. ...
> D. ...
>
> **ã€ç­”æ¡ˆã€‘** (è¿™é‡Œç»™å‡ºæ­£ç¡®é€‰é¡¹)
> **ã€è§£æã€‘** (ä¸€å¥è¯ç®€è¦è§£é‡Šä¸ºä»€ä¹ˆé€‰è¿™ä¸ª)

(æ³¨æ„ï¼šè¯­æ°”è¦äº²åˆ‡ã€å¾ªå¾ªå–„è¯±ï¼Œæ’ç‰ˆè¦æ¸…æ™°ï¼Œç¡®ä¿æ¨¡æ‹Ÿé¢˜çš„è´¨é‡)`;

        var key = localStorage.getItem('ai_api_key');
        var url = "https://api.deepseek.com/chat/completions";

        try {
            const response = await fetch(url, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + key
                },
                body: JSON.stringify({
                    model: "deepseek-chat",
                    messages: [
                        {"role": "system", "content": "ä½ æ˜¯ä¸“ä¸šçš„å¤‡è€ƒåŠ©æ‰‹ã€‚"},
                        {"role": "user", "content": prompt}
                    ],
                    stream: true // å¼€å¯æµå¼è¾“å‡ºï¼Œä½“éªŒæ›´å¥½
                })
            });

            if (!response.ok) {
                var errText = await response.text();
                throw new Error("APIè¯·æ±‚å¤±è´¥ (" + response.status + "): " + errText);
            }

            // å¤„ç†æµå¼å“åº” (æ‰“å­—æœºæ•ˆæœ)
            const reader = response.body.getReader();
            const decoder = new TextDecoder("utf-8");
            contentDiv.innerHTML = ""; // æ¸…ç©ºåŠ è½½æç¤º
            let fullText = "";

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                
                const chunk = decoder.decode(value, { stream: true });
                const lines = chunk.split("\n");
                
                lines.forEach(line => {
                    if (line.startsWith("data: ")) {
                        const jsonStr = line.replace("data: ", "").trim();
                        if (jsonStr === "[DONE]") return;
                        try {
                            const json = JSON.parse(jsonStr);
                            const content = json.choices[0].delta.content || "";
                            fullText += content;
                            // å®æ—¶æ›´æ–°UIï¼ŒæŠŠ **åŠ ç²—** ç®€å•çš„è½¬ä¸º HTML (ä¸ºäº†ç®€å•ä¸å¼•å…¥Markdownåº“)
                            contentDiv.innerHTML = formatSimpleMarkdown(fullText) + '<span class="cursor-blink"></span>';
                            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                            contentDiv.scrollTop = contentDiv.scrollHeight;
                        } catch (e) { console.warn(e); }
                    }
                });
            }
            // ç§»é™¤å…‰æ ‡
            contentDiv.innerHTML = formatSimpleMarkdown(fullText);

        } catch (error) {
            contentDiv.innerHTML = `<span style="color:var(--error)">âŒ å‡ºé”™äº†ï¼š${error.message}</span><br><br>å»ºè®®ï¼š<br>1. æ£€æŸ¥ç½‘ç»œæ˜¯å¦é€šç•…<br>2. ç‚¹å‡»å³ä¸‹è§’â€œè®¾ç½®Keyâ€æ£€æŸ¥å¯†é’¥æ˜¯å¦æ­£ç¡®`;
        }
    }

    // ä¸€ä¸ªæå…¶ç®€å•çš„ Markdown æ ¼å¼åŒ–å‡½æ•° (åªå¤„ç†åŠ ç²—å’Œæ¢è¡Œï¼Œé¿å…å¼•å…¥åºå¤§çš„ç¬¬ä¸‰æ–¹åº“)
    function formatSimpleMarkdown(text) {
        // è½¬ä¹‰HTMLé˜²æ­¢æ³¨å…¥
        let html = text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
        // å¤„ç† **åŠ ç²—**
        html = html.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");
        // å¤„ç†æ¢è¡Œ
        // (ç”±äºå¤–å±‚divè®¾ç½®äº† white-space: pre-wrapï¼Œå…¶å®ä¸éœ€è¦æŠŠ \n è½¬ä¸º <br>ï¼Œä½†ä¸ºäº†ä¿é™©èµ·è§)
        return html;
    }
</script>
</body>
</html>